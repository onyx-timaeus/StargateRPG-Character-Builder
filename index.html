<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG Character Builder</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const StargateCharacterEditor = () => {
            // Character state
            const [character, setCharacter] = useState({
                name: '',
                race: '',
                subrace: '',
                abilityChoice: '',
                origins: [],
                originChoices: {},
                raceChoices: {},
                class: '',
                level: 1,
                classFeats: [],
                abilityScoreImprovements: {},
                abilityScores: {
                    strength: 10,
                    dexterity: 10,
                    constitution: 10,
                    intelligence: 10,
                    wisdom: 10,
                    charisma: 10
                },
                hp: 0,
                maxHp: 0,
                determinationPoints: 0,
                armorClass: 10,
                speed: 6,
                initiative: 0,
                moxie: 0,
                proficiencies: {
                    armor: [],
                    weapons: [],
                    tools: [],
                    saves: [],
                    skills: []
                }
            });

            // Complete race data
            const races = {
                'Human': {
                    subraces: {
                        'Standard Human': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'charisma'], value: 2 },
                            abilities: [
                                'Recovery: Regain +TD HP on short rest',
                                'Galactic Seeds: Advantage on Persuasion/Deception during first contact'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Abydonian': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['constitution', 'charisma'], value: 2 },
                            abilities: [
                                'Recovery: Regain +TD HP on short rest',
                                'Free from Ra: Advantage on saves against Goa\'uld technology'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 1, options: 'any' },
                                weapons: { type: 'choice', count: 1, options: 'any' }
                            }
                        },
                        'Tollan': {
                            hitPoints: 8,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'wisdom'], value: 2 },
                            abilities: [
                                'Phase-Shift: Add phase device to base kit',
                                'Advanced Technology: +TD to Engineering checks for Tech Level 4+'
                            ],
                            proficiencies: {
                                skills: {
                                    type: 'mixed',
                                    fixed: ['Science'],
                                    additionalChoice: { count: 1, options: 'any' }
                                }
                            }
                        }
                    }
                },
                'Jaffa': {
                    subraces: {
                        'Jaffa (With Symbiote)': {
                            hitPoints: 12,
                            abilityIncrease: { type: 'choice', options: ['strength', 'dexterity'], value: 2 },
                            abilities: [
                                'Symbiote: Advantage on physical saves (once per Proficiency bonus per long rest)',
                                'Kelno\'reem: Heal damage as if HD rolled max during long rest',
                                'Proficiency with Jaffa weapons'
                            ],
                            proficiencies: {
                                weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                                skills: { type: 'choice', count: 1, options: 'any' }
                            }
                        },
                        'Free Jaffa (Tretonin)': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['dexterity', 'wisdom'], value: 2 },
                            abilities: [
                                'Resistance Training: Half proficiency bonus to attack rolls with non-proficient weapons',
                                'Tretonin Prescription: Advantage on saves vs disease, suffer 1d4 Con damage daily without drug',
                                'Proficiency with Jaffa weapons'
                            ],
                            proficiencies: {
                                weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                                skills: { type: 'choice', count: 1, options: ['skill', 'equipment'] }
                            }
                        }
                    }
                },
                'Aturen': {
                    subraces: {
                        'Standard Aturen': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['wisdom', 'charisma'], value: 2 },
                            abilities: [
                                'Natural Resilience: Advantage on saves against disease or poison',
                                'Naturalist: Add +TD to Science checks involving ecosystems and creatures'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Noxian Pacifist': {
                            hitPoints: 8,
                            abilityIncrease: { type: 'choice', options: ['constitution', 'charisma'], value: 2 },
                            abilities: [
                                'Pacifist: Cannot willingly harm living creatures or take attack actions',
                                'Invisibility: Become invisible for 1 minute as action (Prof bonus times per long rest)',
                                'Natural Resilience: Advantage on saves against disease or poison',
                                'Naturalist: Add +TD to Science checks involving ecosystems and creatures'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                },
                'Tok\'ra': {
                    subraces: {
                        'Tok\'ra (Egeria\'s Line)': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'wisdom'], value: 2 },
                            abilities: [
                                'Synergistic Symbiote: Advantage on mental saves (once per Wis mod per long rest)',
                                'Regeneration: Heal to full HP during long rest',
                                'Genetic Memory: Access to centuries of knowledge',
                                'Naquadah in blood: Can use Goa\'uld/Tok\'ra technology'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Pangaran Tok\'ra': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['charisma', 'wisdom'], value: 2 },
                            abilities: [
                                'Shrewd Diplomats: Use Int or Wis instead of Cha for Persuasion',
                                'Regeneration: Heal to full HP during long rest',
                                'No genetic memory (created with flaw)'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                },
                'Unas': {
                    subraces: {
                        'Standard Unas': {
                            hitPoints: 14,
                            abilityIncrease: { type: 'choice', options: ['strength', 'constitution'], value: 2 },
                            abilities: [
                                'Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)',
                                'Robust: +4 Str for lifting/carrying, advantage on related Str checks',
                                'Claws: Natural weapons deal 1d6 damage'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Unchained Unas': {
                            hitPoints: 14,
                            abilityIncrease: { type: 'choice', options: ['strength', 'constitution'], value: 2 },
                            abilities: [
                                'Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)',
                                'Underestimated: Advantage on checks to conceal truth from non-Unas',
                                'Claws: Natural weapons deal 1d6 damage'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                }
            };

            // Helper function to describe proficiencies
            const getProficiencyDescription = (proficiencies) => {
                const descriptions = [];
                
                if (proficiencies?.skills) {
                    if (proficiencies.skills.type === 'choice') {
                        descriptions.push(`Choose ${proficiencies.skills.count} skill${proficiencies.skills.count > 1 ? 's' : ''}`);
                    } else if (proficiencies.skills.type === 'mixed') {
                        const fixedSkills = proficiencies.skills.fixed.join(', ');
                        descriptions.push(`${fixedSkills} (fixed)`);
                        if (proficiencies.skills.additionalChoice) {
                            descriptions.push(`Choose ${proficiencies.skills.additionalChoice.count} additional skill${proficiencies.skills.additionalChoice.count > 1 ? 's' : ''}`);
                        }
                    }
                }
                
                if (proficiencies?.weapons) {
                    if (proficiencies.weapons.type === 'choice') {
                        descriptions.push(`Choose ${proficiencies.weapons.count} weapon proficiency`);
                    } else if (proficiencies.weapons.type === 'fixed') {
                        descriptions.push(`${proficiencies.weapons.list.join(', ')} (fixed)`);
                    }
                }
                
                return descriptions;
            };

            // Class data
            const classes = {
                'Diplomat': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms'],
                        tools: ['Research Kit'],
                        saves: ['Wisdom', 'Charisma'],
                        skills: ['Culture', 'Deception', 'Insight', 'Persuasion']
                    },
                    abilities: {
                        1: ['Inspire (1d6 temp HP to team during long rest)', 'Choose Inspiration feat'],
                        2: ['Pep Talk (restore 1d4 DP to team once per mission)', 'Word In An Ear (inspire single target)'],
                        3: ['Force of Will (use Inspire on short/long rest)', 'Choose 2nd Inspiration feat'],
                        4: ['Diplomatic Expertise (double proficiency)', 'Ability Score Improvement'],
                        5: ['Strong Personality (Inspire die to 1d8)', 'Choose 3rd Inspiration feat']
                    },
                    featChoices: {
                        1: { type: 'inspiration', count: 1 },
                        3: { type: 'inspiration', count: 1 },
                        5: { type: 'inspiration', count: 1 }
                    }
                },
                'Engineer': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms', 'Longarms'],
                        tools: ['Engineering Kit', 'Explosives', 'Fabrication Kit'],
                        saves: ['Dexterity', 'Intelligence'],
                        skills: ['Engineering', 'Pilot', 'Perception']
                    },
                    abilities: {
                        1: ['Jury Rig (2d8 repair, action repair)', 'Choose Modification feat'],
                        2: ['Hold Together (resistance with cover)', 'Whack-It (1d6 temp HP bonus action)'],
                        3: ['Tune-Up (+Int to repairs)', 'Choose 2nd Modification feat'],
                        4: ['Broad Spectrum Scanners (Int for Perception)', 'Ability Score Improvement'],
                        5: ['Xeno-Tech Specialist (reduce R&D time)', 'Choose 3rd Modification feat']
                    },
                    featChoices: {
                        1: { type: 'modification', count: 1 },
                        3: { type: 'modification', count: 1 },
                        5: { type: 'modification', count: 1 }
                    }
                },
                'Medic': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms', 'Shotguns'],
                        tools: ['Med Kit', 'Outbreak Kit'],
                        saves: ['Dexterity', 'Wisdom'],
                        skills: ['Athletics', 'Insight', 'Medicine', 'Science']
                    },
                    abilities: {
                        1: ['First Aid (add proficiency to healing, heal as action)', 'Choose Procedure feat'],
                        2: ['Triage (learn target HP with Medicine check)', 'Unnoticed Field Medic (disadvantage on attacks after healing)'],
                        3: ['Man Down (dying allies need fewer death saves)', 'Choose 2nd Procedure feat'],
                        4: ['Physician Heal Thyself (use med kit on self as bonus action)', 'Ability Score Improvement'],
                        5: ['First Response (add WIS modifier to healing)', 'Choose 3rd Procedure feat']
                    },
                    featChoices: {
                        1: { type: 'procedure', count: 1 },
                        3: { type: 'procedure', count: 1 },
                        5: { type: 'procedure', count: 1 }
                    }
                },
                'Scientist': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms'],
                        tools: ['Explosives', 'Research Kit', 'Translator'],
                        saves: ['Intelligence', 'Wisdom'],
                        skills: ['Culture', 'Investigation', 'Nature', 'Science']
                    },
                    abilities: {
                        1: ['Eureka (gain points on Int/Wis failures)', 'Choose Discovery feat'],
                        2: ['Apt Analogy (+TD to ally checks)', 'Great Mind (immune to charm, advantage vs lies)'],
                        3: ['Cross-discipline Studies (half prof to non-proficient)', 'Choose 2nd Discovery feat'],
                        4: ['Resilient Mind (reduce mental damage)', 'Ability Score Improvement'],
                        5: ['Casual Genius (start with Eureka points)', 'For Science! (Eureka for Cha)', 'Choose 3rd Discovery feat']
                    },
                    featChoices: {
                        1: { type: 'discovery', count: 1 },
                        3: { type: 'discovery', count: 1 },
                        5: { type: 'discovery', count: 1 }
                    }
                },
                'Scout': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms', 'Longarms', 'Shotguns', 'Sniper Rifles'],
                        tools: ['Camo Kit'],
                        saves: ['Dexterity', 'Wisdom'],
                        skills: { choose: 4, from: ['Acrobatics', 'Animal Handling', 'Athletics', 'Investigation', 'Nature', 'Perception', 'Sleight of Hand', 'Stealth', 'Survival'] }
                    },
                    abilities: {
                        1: ['Hunter\'s Quarry (mark target for +1d6 damage)', 'Sneak Attack (+1d6 damage with advantage)'],
                        2: ['Swift Hunter (hide as bonus action from quarry)', 'Expertise (double proficiency for 2 skills)'],
                        3: ['Uncanny Dodge (reaction for resistance)', 'Scout\'s Cunning (bonus action dash/disengage/hide)'],
                        4: ['Ability Score Improvement'],
                        5: ['Evasion (half damage on Dex saves)']
                    },
                    featChoices: {}
                },
                'Soldier': {
                    hitDie: 10,
                    hpPerLevel: 6,
                    determinationBonus: 1,
                    proficiencies: {
                        armor: ['Light Armor', 'Heavy Armor'],
                        weapons: ['Common Weapons', 'Martial Arts', 'Sidearms', 'Longarms'],
                        tools: ['Camo Kit', 'Explosives'],
                        saves: ['Strength', 'Constitution'],
                        skills: ['Athletics', 'Intimidation', 'Pilot']
                    },
                    abilities: {
                        1: ['Tactical Flexibility (activate unknown tactic)', 'Choose Tactic feat'],
                        2: ['Surge (extra action, once per rest)', 'Rally (heal TD HP when wounded at combat start)'],
                        3: ['Martial Training (min d8 melee damage)', 'Improved Critical (19-20 with chosen weapon)'],
                        4: ['Ability Score Improvement', 'Choose 2nd Tactic feat'],
                        5: ['Tactical Superiority (two tactics active)']
                    },
                    featChoices: {
                        1: { type: 'tactic', count: 1 },
                        4: { type: 'tactic', count: 1 }
                    }
                }
            };

            // Feat definitions
            const feats = {
                inspiration: [
                    { name: 'Calm and Collected', description: 'During long rest, choose Int/Wis/Cha. Inspired characters gain advantage on chosen save' },
                    { name: 'Clear Focus', description: 'During long rest, choose a skill. Inspired characters gain advantage on that skill' },
                    { name: 'Coordinated Fire', description: 'After you hit, bonus action to grant inspired ally advantage on next attack vs same target' },
                    { name: 'Defensive Motivation', description: 'Inspired characters gain +1 AC' },
                    { name: 'Enduring Inspirations', description: 'At combat start, inspired characters gain tension die worth of Inspire HP' },
                    { name: 'Grim Resolve', description: 'When inspired character loses last Inspire HP, gain resistance to physical damage until next turn' },
                    { name: 'Hard Day\'s Night', description: 'Inspired characters reduce exhaustion from environment/exertion by 1 level (min 1)' },
                    { name: 'Quippy Comebacks', description: 'Once per Diplomatic Function, inspired characters halve DP loss from failed checks' },
                    { name: 'Skillful Explanations', description: 'Once per short rest, allow inspired character to re-roll failed skill check you\'re proficient in' }
                ],
                modification: [
                    { name: 'Armorer', description: 'During long rest, grant one armor +1 AC until next rest' },
                    { name: 'Chem Thrower', description: 'During long rest, grant line/cone weapon +5m range' },
                    { name: 'Comms Tech', description: 'Team radio range 20km (not 5km), balloon duration 15d6 hours' },
                    { name: 'Grenadier', description: 'Your grenades deal +1d6 damage' },
                    { name: 'Longarm Calibrations', description: 'During long rest, grant longarm +1d4 to attack at long range' },
                    { name: 'Minefield Expert', description: 'Bury explosives as mines, advantage to spot mines' },
                    { name: 'Montage', description: 'Reduce R&D successes needed by half proficiency bonus' },
                    { name: 'Percussive Maintenance', description: 'Machines you grant temp HP to heal +1d6 additional temp HP' },
                    { name: 'Sidearm Calibrations', description: 'During long rest, grant sidearm +1 to attack and damage' }
                ],
                procedure: [
                    { name: 'Biohazard Disposal', description: 'Team proficient in Constitution saves vs disease/toxins/viruses' },
                    { name: 'Controlled Stimulants', description: 'Use Med Kit to heal 1d4 exhaustion (once per rest per character)' },
                    { name: 'Crash Training', description: 'Use Med Kit to revive dead character (DC 25 Medicine, once per round)' },
                    { name: 'Embolism', description: 'Melee attack deals 1d3 Constitution damage' },
                    { name: 'Improvised Medicine', description: 'Heal without Med Kit but target not proficient with' },
                    { name: 'Pharmaceuticals', description: 'Heal 1d4 Int/Wis/Cha damage during short rest' },
                    { name: 'Sedatives', description: 'Melee attack causes unconsciousness (Con save or 1d6 fatigue levels)' },
                    { name: 'Urgent Care', description: 'Replace all healing dice rolled with tension dice' },
                    { name: 'Vital Organ Trauma', description: 'Add Wisdom modifier to critical hit damage' }
                ],
                discovery: [
                    { name: 'A Moment\'s Thought', description: 'During rest, spend Eureka to re-roll failed Int/Wis check' },
                    { name: 'Archaeologist', description: 'Action to spend Eureka and find secret rooms, advantage on finding hidden architecture' },
                    { name: 'Astronomer', description: 'Bonus action to reduce Stargate activation by 1 round per Eureka' },
                    { name: 'Biologist', description: 'Action to spend Eureka points to heal 1d6 per point' },
                    { name: 'Chemist', description: 'Research Kit ranged attack deals 1d6 acid per Eureka (increases with level)' },
                    { name: 'Geologist', description: 'Reaction to spend Eureka and negate natural cover' },
                    { name: 'Hyper-Focus', description: 'Spend Eureka to add tension die to Int/Wis check' },
                    { name: 'Physicist', description: 'Spend Eureka to increase weapon range by 50%' },
                    { name: 'Social Sciences', description: 'Gain 1 Eureka when losing Determination Points' }
                ],
                tactic: [
                    { name: 'Ambush', description: 'Team gains advantage on first melee attack after rest' },
                    { name: 'Assault Coordination', description: 'Next ranged attack by teammate after you hit deals +1d6' },
                    { name: 'Coordinated Response', description: 'Team can use your initiative result' },
                    { name: 'Defensive Posture', description: 'Allies within 2m gain +2 AC' },
                    { name: 'Distracting Attacks', description: 'Target has disadvantage vs chosen ally not within 2m' },
                    { name: 'Hit & Run', description: 'Bonus action to let ally Disengage' },
                    { name: 'Overwatchers', description: '90° overwatch field (not 45°), make 2 attacks' },
                    { name: 'Response Shot', description: 'Once per encounter, reaction attack when enemy attacks ally' },
                    { name: 'Rush', description: 'Bonus action to let ally Dash' }
                ]
            };

            // Lists
            const availableTools = ['Camo Kit', 'Explosives', 'Med Kit', 'Research Kit', 'Surgical Kit', 'Translator', 'Thieves\' Tools', 'Tok\'ra tunneling crystals', 'Engineering tools'];
            const availableSkills = ['Acrobatics', 'Athletics', 'Culture', 'Deception', 'Engineering', 'Insight', 'Intimidation', 'Investigation', 'Medicine', 'Nature', 'Perception', 'Performance', 'Persuasion', 'Pilot', 'Science', 'Sleight of Hand', 'Stealth', 'Survival'];
            const availableWeapons = ['Common Weapons', 'Bows', 'Martial Arts', 'Sidearms', 'Shotguns', 'Longarms', 'Grenades', 'Heavy Ordinance', 'Jaffa Weapons'];
            const availableArmor = ['Light Armor', 'Medium Armor', 'Heavy Armor', 'Shields'];

            // Origins data
            const origins = {
                biome: [
                    { name: 'Lunar', attribute: 'Dexterity +1', ability: 'Eager Astronomer: Advantage on Science checks pertaining to astronomy' },
                    { name: 'Arboreal', attribute: 'Strength +1', ability: 'Natural Climber: Climb speed of 6m' },
                    { name: 'Mountainous', attribute: 'Strength +1', ability: 'Vertical Drop: Half falling damage' },
                    { name: 'Artificial', attribute: 'Wisdom +1', ability: 'Life or Death Repairs: Advantage on engineering when failure would deal damage' },
                    { name: 'Oceanic', attribute: 'Wisdom +1', ability: 'Gifted Swimmer: Swim speed of 6m' },
                    { name: 'Desert', attribute: 'Charisma +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                    { name: 'Rainforest', attribute: 'Charisma +1', ability: 'Tropics Adept: No disadvantage from rain or fog' },
                    { name: 'Grasslands', attribute: 'Constitution +1', ability: 'Natural Sprinter: +1m movement speed' },
                    { name: 'Starship', attribute: 'Dexterity +1', ability: 'Void Adept: Use Wis for Science checks' },
                    { name: 'Terraformed', attribute: 'Intelligence +1', ability: 'Strange World: 1/day reaction for advantage on save' },
                    { name: 'Swamp', attribute: 'Wisdom +1', ability: 'Patient Hunter: Use Wis for Stealth checks' },
                    { name: 'Toxic', attribute: 'Constitution +1', ability: 'Toxic Resistance: Resist poison or necrotic (choose one)' },
                    { name: 'Urban', attribute: 'Intelligence +1', ability: 'Melting Pot: Use Cha for Culture checks' },
                    { name: 'Tundra', attribute: 'Constitution +1', ability: 'Cold Acclimated: Resistance to cold damage' },
                    { name: 'Volcanic', attribute: 'Strength +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                    { name: 'Subterranean', attribute: 'Dexterity +1', ability: 'Improved Vision: Dim light counts as bright' }
                ],
                background: [
                    { name: 'Enforcement', proficiency: 'Intimidation', ability: 'Air of Authority: Others have disadvantage to intimidate you' },
                    { name: 'Aviator', proficiency: 'Pilot', ability: 'Crash Landing: Resistance to damage when vehicle crashes' },
                    { name: 'Driver', proficiency: 'Animal Handling', ability: 'Speedster: Vehicles/animals you control gain +1 AC' },
                    { name: 'Enslaved', proficiency: { type: 'choice', options: ['Tool'] }, ability: 'Friend to Toil: Suffer 1 less exhaustion level (min 1)' },
                    { name: 'Former Host', proficiency: 'None', ability: 'Naquadah Blooded: Can use Goa\'uld tech, advantage vs symbiotes' },
                    { name: 'Entertainer', proficiency: 'Performance', ability: 'Zeitgeist: Use Cha for art/performance understanding' },
                    { name: 'Freedom Fighter', proficiency: 'Stealth', ability: 'Last Resorts: Disadvantage on Moxie, advantage on Initiative' },
                    { name: 'Healer', proficiency: 'Medicine', ability: 'Soothe: Team heals +Prof bonus on rest' },
                    { name: 'Military', proficiency: { type: 'choice', options: ['Weapon', 'Armor'] }, ability: 'Drills: +1 HP per level' },
                    { name: 'Herdsman', proficiency: 'Animal Handling', ability: 'Beastfriend: Use Cha instead of Wis for Animal Handling' },
                    { name: 'Preservationist', proficiency: 'Nature', ability: 'Eye for Nature: Advantage on checks to identify plants' },
                    { name: 'Hunter/Gatherer', proficiency: 'Survival', ability: 'Irongut: Advantage vs poison' },
                    { name: 'Politician', proficiency: 'Persuasion', ability: 'Two Faces: Use Int instead of Cha for Deception' },
                    { name: 'Liaison', proficiency: 'Culture', ability: 'Stranger to the Land: Advantage on Cha checks to hide foreign nature' },
                    { name: 'Refugee', proficiency: 'Athletics', ability: 'New Environments: Advantage on Athletics in unknown wilderness' },
                    { name: 'Merchant', proficiency: 'Insight', ability: 'Efficient Logistics: +1 bulk capacity' },
                    { name: 'Sailor', proficiency: 'Acrobatics', ability: 'Sea Legs: Advantage to maintain balance' },
                    { name: 'Swindler', proficiency: 'Deception', ability: 'Low Profile: Use Deception for Stealth in populated areas' },
                    { name: 'Scholar', proficiency: 'Science', ability: 'Preserve Knowledge: Advantage on Persuasion with scholars' },
                    { name: 'Teacher', proficiency: 'Insight', ability: 'Patient Approach: 1/mission use Wis save instead of another' },
                    { name: 'Sentry', proficiency: 'Perception', ability: 'Long Night: Ignore first night without rest' },
                    { name: 'Wright', proficiency: 'Engineering', ability: 'Measure Twice: Half prof bonus on non-proficient tools' },
                    { name: 'Sleuth', proficiency: 'Investigation', ability: 'The Reveal: Advantage on Persuasion to accuse wrongdoing' },
                    { name: 'Underworld', proficiency: 'Sleight of Hand', ability: 'Black Market: Advantage contacting underworld members' },
                    { name: 'Student', proficiency: 'Perception', ability: 'Quick Study: 1/mission use Int save instead of another' }
                ],
                racial: {
                    'Human': [{ name: 'Tau\'ri Military', attribute: 'None', proficiency: { type: 'choice', options: ['Martial Arts', 'Longarms', 'Heavy Armor'] }, ability: 'Basic Training: Chosen proficiency from military service' }],
                    'Jaffa': [
                        { name: 'Jaffa Renegade', attribute: 'Wisdom +1', ability: 'Rebel: Advantage on saves vs Goa\'uld and Jaffa' },
                        { name: 'Student of Bra\'tac', attribute: 'Dexterity +1', ability: 'Ma\'tok Mastery: Ma\'tok gains finesse property' }
                    ],
                    'Aturen': [{ name: 'Aturen Spiritualist', attribute: 'None', ability: 'Ritual of Life: DC 20 Culture check to resurrect' }],
                    'Tok\'ra': [{ name: 'Tok\'ra Spy', attribute: 'Charisma +1', ability: 'Passing: Advantage on Deception as Human/Goa\'uld/Jaffa' }],
                    'Unas': [{ name: 'Unas Alpha', attribute: 'Charisma +1', ability: 'Clan Leader: Other Unas gain advantage on saves/attacks' }]
                }
            };

            // Helper functions
            const getModifier = (score) => Math.floor((score - 10) / 2);

            const getAbilityBonuses = (ability) => {
                let racialBonus = 0;
                let originBonus = 0;
                let asiBonus = 0;
                
                const raceData = races[character.race]?.subraces[character.subrace];
                if (raceData && raceData.abilityIncrease) {
                    if (raceData.abilityIncrease.type === 'choice' && character.abilityChoice === ability) {
                        racialBonus = raceData.abilityIncrease.value;
                    } else if (!raceData.abilityIncrease.type && raceData.abilityIncrease[ability]) {
                        racialBonus = raceData.abilityIncrease[ability];
                    }
                }
                
                character.origins.forEach(originName => {
                    const biomeOrigin = origins.biome.find(o => o.name === originName);
                    const racialOrigin = Object.values(origins.racial).flat().find(o => o.name === originName);
                    
                    if (biomeOrigin && biomeOrigin.attribute !== 'None') {
                        const [attr, val] = biomeOrigin.attribute.split(' +');
                        if (attr.toLowerCase() === ability) {
                            originBonus += parseInt(val);
                        }
                    }
                    
                    if (racialOrigin && racialOrigin.attribute !== 'None') {
                        const [attr, val] = racialOrigin.attribute.split(' +');
                        if (attr.toLowerCase() === ability) {
                            originBonus += parseInt(val);
                        }
                    }
                });
                
                if (character.level >= 4 && character.abilityScoreImprovements) {
                    Object.values(character.abilityScoreImprovements).forEach(improvement => {
                        if (improvement === ability) {
                            asiBonus += 1;
                        } else if (improvement === `${ability}_2`) {
                            asiBonus += 2;
                        }
                    });
                }
                
                return { racialBonus, originBonus, asiBonus };
            };

            const getFinalAbilityScores = () => {
                const finalScores = { ...character.abilityScores };
                Object.keys(finalScores).forEach(ability => {
                    const { racialBonus, originBonus, asiBonus } = getAbilityBonuses(ability);
                    finalScores[ability] += racialBonus + originBonus + asiBonus;
                });
                return finalScores;
            };

            const getHPBreakdown = () => {
                const breakdown = { classBase: 0, conModifier: 0, raceBonus: 0, levelBonus: 0, militaryBonus: 0, total: 0 };
                if (!character.race || !character.subrace || !character.class) return breakdown;
                
                const raceData = races[character.race]?.subraces[character.subrace];
                const classData = classes[character.class];
                const finalScores = getFinalAbilityScores();
                const conMod = getModifier(finalScores.constitution);
                
                breakdown.classBase = classData.hitDie;
                breakdown.conModifier = conMod;
                breakdown.raceBonus = raceData.hitPoints;
                
                if (character.origins.includes('Military')) {
                    breakdown.militaryBonus = character.level;
                }
                
                if (character.level > 1) {
                    breakdown.levelBonus = (character.level - 1) * (classData.hpPerLevel + conMod);
                }
                
                breakdown.total = Math.max(1, breakdown.classBase + breakdown.conModifier + breakdown.raceBonus + breakdown.levelBonus + breakdown.militaryBonus);
                return breakdown;
            };

            const getDeterminationBreakdown = () => {
                const breakdown = { base: Math.floor((character.level + 4) / 5) * 2, classBonus: 0, total: 0 };
                if (character.class) {
                    breakdown.classBonus = classes[character.class].determinationBonus;
                }
                breakdown.total = breakdown.base + breakdown.classBonus;
                return breakdown;
            };

            const getACBreakdown = () => {
                const finalScores = getFinalAbilityScores();
                const dexMod = getModifier(finalScores.dexterity);
                return { base: 10, dexModifier: dexMod, armorBonus: 0, total: 10 + dexMod };
            };

            const getInitiativeBreakdown = () => {
                const finalScores = getFinalAbilityScores();
                const dexMod = getModifier(finalScores.dexterity);
                const wisMod = getModifier(finalScores.wisdom);
                return { dexModifier: dexMod, wisModifier: wisMod, total: Math.max(dexMod, wisMod) };
            };

            const getMoxieBreakdown = () => {
                const finalScores = getFinalAbilityScores();
                const intMod = getModifier(finalScores.intelligence);
                const chaMod = getModifier(finalScores.charisma);
                return { intModifier: intMod, chaModifier: chaMod, total: Math.max(intMod, chaMod) };
            };

            const getRequiredFeatCount = () => {
                if (!character.class) return 0;
                const classData = classes[character.class];
                if (!classData.featChoices) return 0;
                
                let totalFeats = 0;
                Object.entries(classData.featChoices).forEach(([level, choice]) => {
                    if (parseInt(level) <= character.level) {
                        totalFeats += choice.count;
                    }
                });
                return totalFeats;
            };

            const getClassFeatType = () => {
                if (!character.class) return null;
                const classData = classes[character.class];
                if (!classData.featChoices) return null;
                const firstChoice = Object.values(classData.featChoices)[0];
                return firstChoice ? firstChoice.type : null;
            };

            // Update derived stats
            useEffect(() => {
                const hpBreakdown = getHPBreakdown();
                const finalScores = getFinalAbilityScores();
                const dexMod = getModifier(finalScores.dexterity);
                const wisMod = getModifier(finalScores.wisdom);
                const intMod = getModifier(finalScores.intelligence);
                const chaMod = getModifier(finalScores.charisma);
                
                let speed = 6;
                if (character.origins.includes('Grasslands')) {
                    speed = 7;
                }
                
                setCharacter(prev => ({
                    ...prev,
                    hp: hpBreakdown.total,
                    maxHp: hpBreakdown.total,
                    initiative: Math.max(dexMod, wisMod),
                    moxie: Math.max(intMod, chaMod),
                    armorClass: 10 + dexMod,
                    speed: speed,
                    determinationPoints: getDeterminationBreakdown().total
                }));
            }, [character.race, character.subrace, character.class, character.level, character.abilityScores, character.abilityChoice, character.origins, character.abilityScoreImprovements]);

            // Point buy system
            const pointBuyCost = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
            const getPointsSpent = () => {
                return Object.values(character.abilityScores).reduce((sum, score) => {
                    return sum + (pointBuyCost[score] || 0);
                }, 0);
            };

            const updateAbilityScore = (ability, value) => {
                const newValue = Math.max(8, Math.min(15, value));
                setCharacter(prev => ({
                    ...prev,
                    abilityScores: {
                        ...prev.abilityScores,
                        [ability]: newValue
                    }
                }));
            };

            // Export function
            const exportCharacterSheet = () => {
                const raceData = races[character.race]?.subraces[character.subrace];
                const classData = classes[character.class];
                const finalScores = getFinalAbilityScores();
                
                let featList = '';
                if (character.classFeats) {
                    character.classFeats.forEach((featName, idx) => {
                        featList += `Feat ${idx + 1}: ${featName}\n`;
                    });
                }
                
                let asiList = '';
                if (character.abilityScoreImprovements) {
                    Object.entries(character.abilityScoreImprovements).forEach(([key, value]) => {
                        if (value) {
                            asiList += `${key}: ${value}\n`;
                        }
                    });
                }
                
                const sheet = `STARGATE RPG CHARACTER SHEET
=============================
Name: ${character.name || 'Unnamed Character'}
Race: ${character.race} (${character.subrace})
Origins: ${character.origins.join(', ')}
Class: ${character.class}
Level: ${character.level}

ABILITY SCORES (with racial modifiers)
Strength:     ${finalScores.strength} (${getModifier(finalScores.strength) >= 0 ? '+' : ''}${getModifier(finalScores.strength)})
Dexterity:    ${finalScores.dexterity} (${getModifier(finalScores.dexterity) >= 0 ? '+' : ''}${getModifier(finalScores.dexterity)})
Constitution: ${finalScores.constitution} (${getModifier(finalScores.constitution) >= 0 ? '+' : ''}${getModifier(finalScores.constitution)})
Intelligence: ${finalScores.intelligence} (${getModifier(finalScores.intelligence) >= 0 ? '+' : ''}${getModifier(finalScores.intelligence)})
Wisdom:       ${finalScores.wisdom} (${getModifier(finalScores.wisdom) >= 0 ? '+' : ''}${getModifier(finalScores.wisdom)})
Charisma:     ${finalScores.charisma} (${getModifier(finalScores.charisma) >= 0 ? '+' : ''}${getModifier(finalScores.charisma)})

COMBAT STATS
Hit Points: ${character.hp}/${character.maxHp}
Armor Class: ${character.armorClass}
Initiative: ${character.initiative >= 0 ? '+' : ''}${character.initiative}
Speed: ${character.speed}m
Determination Points: ${character.determinationPoints}
Moxie: ${character.moxie >= 0 ? '+' : ''}${character.moxie}

RACIAL ABILITIES
${raceData ? raceData.abilities.join('\n') : 'None'}

CLASS ABILITIES
${classData ? 
  Object.entries(classData.abilities)
    .filter(([lvl, _]) => parseInt(lvl) <= character.level)
    .map(([lvl, abilities]) => `Level ${lvl}: ${abilities.join(', ')}`)
    .join('\n') : ''}

CLASS FEATS SELECTED
${featList || 'None selected'}

ABILITY SCORE IMPROVEMENTS
${asiList || 'None selected'}
`;
                
                const element = document.createElement('a');
                const file = new Blob([sheet], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = `${character.name || 'stargate_character'}_sheet.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const needsAbilityChoice = () => {
                const raceData = races[character.race]?.subraces[character.subrace];
                return raceData?.abilityIncrease?.type === 'choice' && !character.abilityChoice;
            };

            const allChoicesMade = () => {
                const raceData = races[character.race]?.subraces[character.subrace];
                if (raceData?.proficiencies) {
                    if (raceData.proficiencies.skills?.type === 'choice') {
                        const required = raceData.proficiencies.skills.count;
                        const chosen = character.raceChoices.skills?.length || 0;
                        if (chosen < required) return false;
                    }
                    
                    if (raceData.proficiencies.skills?.type === 'mixed' && raceData.proficiencies.skills.additionalChoice) {
                        const required = raceData.proficiencies.skills.additionalChoice.count;
                        const chosen = character.raceChoices.additionalSkills?.length || 0;
                        if (chosen < required) return false;
                    }
                    
                    if (raceData.proficiencies.weapons?.type === 'choice') {
                        const required = raceData.proficiencies.weapons.count;
                        const chosen = character.raceChoices.weapons?.length || 0;
                        if (chosen < required) return false;
                    }
                }
                
                for (const originName of character.origins) {
                    const backgroundOrigin = origins.background.find(o => o.name === originName);
                    if (backgroundOrigin?.proficiency?.type === 'choice' && !character.originChoices[originName]) {
                        return false;
                    }
                    
                    const racialOrigin = origins.racial[character.race]?.find(o => o.name === originName);
                    if (racialOrigin?.proficiency?.type === 'choice' && !character.originChoices[originName]) {
                        return false;
                    }
                }
                
                const requiredFeats = getRequiredFeatCount();
                const selectedFeats = character.classFeats.length;
                if (selectedFeats < requiredFeats) return false;
                
                if (character.level >= 4 && (!character.abilityScoreImprovements || Object.keys(character.abilityScoreImprovements).length === 0)) {
                    return false;
                }
                
                return true;
            };

            // JSX Return
            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                            <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                                <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                    <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                        <span className="text-2xl">🎯</span>
                                    </div>
                                    Stargate RPG Character Editor
                                </h1>
                                <p className="text-blue-100 mt-2">Create your Phoenix Site operative</p>
                            </div>

                            <div className="p-6 space-y-6">
                                {/* Character Name */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Character Name</label>
                                    <input
                                        type="text"
                                        value={character.name}
                                        onChange={(e) => setCharacter(prev => ({ ...prev, name: e.target.value }))}
                                        className="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none"
                                        placeholder="Enter character name..."
                                    />
                                </div>

                                {/* Race Selection */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Select Race</label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {Object.keys(races).map(race => (
                                            <button
                                                key={race}
                                                onClick={() => setCharacter(prev => ({ ...prev, race, subrace: '', abilityChoice: '', raceChoices: {} }))}
                                                className={`p-3 rounded-lg border-2 transition-all ${character.race === race ? 'border-blue-500 bg-blue-500/20 text-white' : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'}`}
                                            >
                                                <div className="font-semibold">{race}</div>
                                                <div className="text-xs mt-1 opacity-75">{Object.keys(races[race].subraces).length} variant(s)</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Subrace Selection */}
                                {character.race && (
                                    <div className="bg-gray-700/50 rounded-lg p-4">
                                        <label className="block text-sm font-medium text-gray-300 mb-2">Select {character.race} Variant</label>
                                        <div className="space-y-3">
                                            {Object.entries(races[character.race].subraces).map(([subraceName, subraceData]) => {
                                                const proficiencyDesc = getProficiencyDescription(subraceData.proficiencies);
                                                return (
                                                    <div
                                                        key={subraceName}
                                                        onClick={() => setCharacter(prev => ({ ...prev, subrace: subraceName, abilityChoice: '', raceChoices: {} }))}
                                                        className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${character.subrace === subraceName ? 'border-green-500 bg-green-500/20' : 'border-gray-600 bg-gray-800 hover:border-gray-500'}`}
                                                    >
                                                        <div className="font-semibold text-white mb-2">{subraceName}</div>
                                                        <div className="text-xs text-gray-400 space-y-1">
                                                            <div>HP Bonus: +{subraceData.hitPoints}</div>
                                                            <div className="flex items-start gap-1">
                                                                <span>Ability Increase:</span>
                                                                <span className={subraceData.abilityIncrease.type === 'choice' ? 'text-yellow-300' : 'text-gray-400'}>
                                                                    {subraceData.abilityIncrease.type === 'choice' ? (
                                                                        <>
                                                                            <span className="inline-block mr-1">⚠️</span>
                                                                            Choose ONE: +{subraceData.abilityIncrease.value} to {subraceData.abilityIncrease.options.join(' OR ')}
                                                                        </>
                                                                    ) : (
                                                                        Object.entries(subraceData.abilityIncrease)
                                                                            .filter(([key]) => key !== 'type')
                                                                            .map(([key, val]) => `${key}: +${val}`)
                                                                            .join(', ')
                                                                    )}
                                                                </span>
                                                            </div>
                                                            {proficiencyDesc.length > 0 && (
                                                                <div className="mt-2">
                                                                    <span className="font-semibold text-gray-300">Proficiencies:</span>
                                                                    <ul className="ml-2 mt-1">
                                                                        {proficiencyDesc.map((desc, idx) => (
                                                                            <li key={idx} className="text-xs text-blue-300">• {desc}</li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                            <div className="mt-2">
                                                                <span className="font-semibold text-gray-300">Abilities:</span>
                                                                <ul className="ml-2 mt-1">
                                                                    {subraceData.abilities.map((ability, idx) => (
                                                                        <li key={idx} className="text-xs">• {ability}</li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {/* Class Selection */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Select Class</label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {Object.keys(classes).map(className => (
                                            <button
                                                key={className}
                                                onClick={() => setCharacter(prev => ({ ...prev, class: className, classFeats: [], abilityScoreImprovements: {} }))}
                                                className={`p-3 rounded-lg border-2 transition-all ${character.class === className ? 'border-purple-500 bg-purple-500/20 text-white' : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'}`}
                                            >
                                                <div className="font-semibold">{className}</div>
                                                <div className="text-xs mt-1 opacity-75">HD: d{classes[className].hitDie}, DP: +{classes[className].determinationBonus}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Level Selection */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Character Level</label>
                                    <div className="flex gap-2">
                                        {[1, 2, 3, 4, 5].map(level => (
                                            <button
                                                key={level}
                                                onClick={() => setCharacter(prev => ({ ...prev, level }))}
                                                className={`px-4 py-2 rounded-lg border-2 transition-all ${character.level === level ? 'border-green-500 bg-green-500/20 text-white' : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'}`}
                                            >
                                                Level {level}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Combat Statistics */}
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <h3 className="text-lg font-semibold text-gray-300 mb-4">Combat Statistics</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-red-400 mb-1">
                                                <span>❤️</span>
                                                <span className="text-xs">Hit Points</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.hp || 0}</div>
                                        </div>
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-blue-400 mb-1">
                                                <span>🛡️</span>
                                                <span className="text-xs">Armor Class</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.armorClass}</div>
                                        </div>
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-yellow-400 mb-1">
                                                <span>⚡</span>
                                                <span className="text-xs">Initiative</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.initiative >= 0 ? '+' : ''}{character.initiative}</div>
                                        </div>
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-purple-400 mb-1">
                                                <span>🧠</span>
                                                <span className="text-xs">Determination</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.determinationPoints}</div>
                                        </div>
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-green-400 mb-1">
                                                <span>📊</span>
                                                <span className="text-xs">Speed</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.speed}m</div>
                                        </div>
                                        <div className="bg-gray-800 rounded-lg p-3">
                                            <div className="flex items-center gap-2 text-cyan-400 mb-1">
                                                <span>👤</span>
                                                <span className="text-xs">Moxie</span>
                                            </div>
                                            <div className="text-2xl font-bold text-white">{character.moxie >= 0 ? '+' : ''}{character.moxie}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Export Button */}
                                <div className="flex justify-end">
                                    <button
                                        onClick={exportCharacterSheet}
                                        disabled={!character.race || !character.subrace || !character.class}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
                                    >
                                        <span>⬇️</span>
                                        Export Character Sheet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(StargateCharacterEditor));
    </script>
</body>
</html>
