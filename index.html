<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG Character Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations and styles */
        .transition-all {
            transition: all 0.3s ease;
        }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.7);
        }
        
        /* Icon styles */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: middle;
            fill: currentColor;
        }
        
        .icon-sm { width: 0.75rem; height: 0.75rem; }
        .icon-md { width: 1rem; height: 1rem; }
        .icon-lg { width: 1.25rem; height: 1.25rem; }
        .icon-xl { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
    <div id="app"></div>

    <script>
        // SVG Icons as strings
        const icons = {
            chevronDown: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>',
            user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            shield: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>',
            heart: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
            zap: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            brain: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.44-5A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.44-5A2.5 2.5 0 0 0 14.5 2Z"/></svg>',
            target: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
            activity: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            download: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
            alertCircle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',
            sparkles: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
            award: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            bookOpen: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>'
        };

        // Complete game data
        const gameData = {
            fieldHackFeats: [
                { name: 'Camouflage', requirements: 'Stealth', description: 'Create camouflage granting advantage on Stealth in natural terrain' },
                { name: 'Camp Security', requirements: 'Perception', description: 'Set up camp alarms, advantage on Perception during rest' },
                { name: 'Foraging', requirements: 'Survival', description: 'Find food/water for 1d4+Wis mod people per day' },
                { name: 'Hide Tracks', requirements: 'Stealth', description: 'Increase DC to track your party by +5' },
                { name: 'Ranger Tricks', requirements: 'Nature', description: 'Leave false trails, create natural traps (1d6 damage)' },
                { name: 'Ration Optimization', requirements: 'Survival', description: 'Make rations last 50% longer' },
                { name: 'Rope Tricks', requirements: 'Athletics', description: 'Advantage on Athletics checks involving ropes and climbing' },
                { name: 'Tracking', requirements: 'Survival', description: 'Track creatures, determine numbers and time passed' },
                { name: 'Xenosurvival', requirements: 'Science', description: 'Identify alien flora/fauna as safe or dangerous' }
            ],
            
            classFeatsByType: {
                inspiration: [
                    { name: 'Calm and Collected', description: 'During long rest, choose Int/Wis/Cha. Inspired characters gain advantage on chosen save' },
                    { name: 'Clear Focus', description: 'During long rest, choose a skill. Inspired characters gain advantage on that skill' },
                    { name: 'Coordinated Fire', description: 'After you hit, bonus action to grant inspired ally advantage on next attack vs same target' },
                    { name: 'Defensive Motivation', description: 'Inspired characters gain +1 AC' },
                    { name: 'Enduring Inspirations', description: 'At combat start, inspired characters gain tension die worth of Inspire HP' },
                    { name: 'Grim Resolve', description: 'When inspired character loses last Inspire HP, gain resistance to physical damage until next turn' },
                    { name: 'Hard Days Night', description: 'Inspired characters reduce exhaustion from environment/exertion by 1 level (min 1)' },
                    { name: 'Quippy Comebacks', description: 'Once per Diplomatic Function, inspired characters halve DP loss from failed checks' },
                    { name: 'Skillful Explanations', description: 'Once per short rest, allow inspired character to re-roll failed skill check you are proficient in' }
                ],
                modification: [
                    { name: 'Armorer', description: 'During long rest, grant one armor +1 AC until next rest' },
                    { name: 'Chem Thrower', description: 'During long rest, grant line/cone weapon +5m range' },
                    { name: 'Comms Tech', description: 'Team radio range 20km (not 5km), balloon duration 15d6 hours' },
                    { name: 'Grenadier', description: 'Your grenades deal +1d6 damage' },
                    { name: 'Longarm Calibrations', description: 'During long rest, grant longarm +1d4 to attack at long range' },
                    { name: 'Minefield Expert', description: 'Bury explosives as mines, advantage to spot mines' },
                    { name: 'Montage', description: 'Reduce R&D successes needed by half proficiency bonus' },
                    { name: 'Percussive Maintenance', description: 'Machines you grant temp HP to heal +1d6 additional temp HP' },
                    { name: 'Sidearm Calibrations', description: 'During long rest, grant sidearm +1 to attack and damage' }
                ],
                procedure: [
                    { name: 'Biohazard Disposal', description: 'Team proficient in Constitution saves vs disease/toxins/viruses' },
                    { name: 'Controlled Stimulants', description: 'Use Med Kit to heal 1d4 exhaustion (once per rest per character)' },
                    { name: 'Crash Training', description: 'Use Med Kit to revive dead character (DC 25 Medicine, once per round)' },
                    { name: 'Embolism', description: 'Melee attack deals 1d3 Constitution damage' },
                    { name: 'Improvised Medicine', description: 'Heal without Med Kit but target not proficient with' },
                    { name: 'Pharmaceuticals', description: 'Heal 1d4 Int/Wis/Cha damage during short rest' },
                    { name: 'Sedatives', description: 'Melee attack causes unconsciousness (Con save or 1d6 fatigue levels)' },
                    { name: 'Urgent Care', description: 'Replace all healing dice rolled with tension dice' },
                    { name: 'Vital Organ Trauma', description: 'Add Wisdom modifier to critical hit damage' }
                ],
                discovery: [
                    { name: 'A Moments Thought', description: 'During rest, spend Eureka to re-roll failed Int/Wis check' },
                    { name: 'Archaeologist', description: 'Action to spend Eureka and find secret rooms, advantage on finding hidden architecture' },
                    { name: 'Astronomer', description: 'Bonus action to reduce Stargate activation by 1 round per Eureka' },
                    { name: 'Biologist', description: 'Action to spend Eureka points to heal 1d6 per point' },
                    { name: 'Chemist', description: 'Research Kit ranged attack deals 1d6 acid per Eureka (increases with level)' },
                    { name: 'Geologist', description: 'Reaction to spend Eureka and negate natural cover' },
                    { name: 'Hyper-Focus', description: 'Spend Eureka to add tension die to Int/Wis check' },
                    { name: 'Physicist', description: 'Spend Eureka to increase weapon range by 50%' },
                    { name: 'Social Sciences', description: 'Gain 1 Eureka when losing Determination Points' }
                ],
                tactic: [
                    { name: 'Ambush', description: 'Team gains advantage on first melee attack after rest' },
                    { name: 'Assault Coordination', description: 'Next ranged attack by teammate after you hit deals +1d6' },
                    { name: 'Coordinated Response', description: 'Team can use your initiative result' },
                    { name: 'Defensive Posture', description: 'Allies within 2m gain +2 AC' },
                    { name: 'Distracting Attacks', description: 'Target has disadvantage vs chosen ally not within 2m' },
                    { name: 'Hit and Run', description: 'Bonus action to let ally Disengage' },
                    { name: 'Overwatchers', description: '90° overwatch field (not 45°), make 2 attacks' },
                    { name: 'Response Shot', description: 'Once per encounter, reaction attack when enemy attacks ally' },
                    { name: 'Rush', description: 'Bonus action to let ally Dash' }
                ]
            },

            races: {
                'Human': {
                    subraces: {
                        'Standard Human': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'charisma'], value: 2 },
                            abilities: [
                                'Recovery: Regain +TD HP on short rest',
                                'Galactic Seeds: Advantage on Persuasion/Deception during first contact'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Abydonian': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['constitution', 'charisma'], value: 2 },
                            abilities: [
                                'Recovery: Regain +TD HP on short rest',
                                'Free from Ra: Advantage on saves against Goa\'uld technology'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 1, options: 'any' },
                                weapons: { type: 'choice', count: 1, options: 'any' }
                            }
                        },
                        'Tollan': {
                            hitPoints: 8,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'wisdom'], value: 2 },
                            abilities: [
                                'Phase-Shift: Add phase device to base kit',
                                'Advanced Technology: +TD to Engineering checks for Tech Level 4+'
                            ],
                            proficiencies: {
                                skills: {
                                    type: 'mixed',
                                    fixed: ['Science'],
                                    additionalChoice: { count: 1, options: 'any' }
                                }
                            }
                        }
                    }
                },
                'Jaffa': {
                    subraces: {
                        'Jaffa (With Symbiote)': {
                            hitPoints: 12,
                            abilityIncrease: { type: 'choice', options: ['strength', 'dexterity'], value: 2 },
                            abilities: [
                                'Symbiote: Advantage on physical saves (once per Proficiency bonus per long rest)',
                                'Kelno\'reem: Heal damage as if HD rolled max during long rest',
                                'Proficiency with Jaffa weapons'
                            ],
                            proficiencies: {
                                weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                                skills: { type: 'choice', count: 1, options: 'any' }
                            }
                        },
                        'Free Jaffa (Tretonin)': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['dexterity', 'wisdom'], value: 2 },
                            abilities: [
                                'Resistance Training: Half proficiency bonus to attack rolls with non-proficient weapons',
                                'Tretonin Prescription: Advantage on saves vs disease, suffer 1d4 Con damage daily without drug',
                                'Proficiency with Jaffa weapons'
                            ],
                            proficiencies: {
                                weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                                skills: { type: 'choice', count: 1, options: ['skill', 'equipment'] }
                            }
                        }
                    }
                },
                'Aturen': {
                    subraces: {
                        'Standard Aturen': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['wisdom', 'charisma'], value: 2 },
                            abilities: [
                                'Natural Resilience: Advantage on saves against disease or poison',
                                'Naturalist: Add +TD to Science checks involving ecosystems and creatures'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Noxian Pacifist': {
                            hitPoints: 8,
                            abilityIncrease: { type: 'choice', options: ['constitution', 'charisma'], value: 2 },
                            abilities: [
                                'Pacifist: Cannot willingly harm living creatures or take attack actions',
                                'Invisibility: Become invisible for 1 minute as action (Prof bonus times per long rest)',
                                'Natural Resilience: Advantage on saves against disease or poison',
                                'Naturalist: Add +TD to Science checks involving ecosystems and creatures'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                },
                'Tok\'ra': {
                    subraces: {
                        'Tok\'ra (Egeria\'s Line)': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['intelligence', 'wisdom'], value: 2 },
                            abilities: [
                                'Synergistic Symbiote: Advantage on mental saves (once per Wis mod per long rest)',
                                'Regeneration: Heal to full HP during long rest',
                                'Genetic Memory: Access to centuries of knowledge',
                                'Naquadah in blood: Can use Goa\'uld/Tok\'ra technology'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Pangaran Tok\'ra': {
                            hitPoints: 10,
                            abilityIncrease: { type: 'choice', options: ['charisma', 'wisdom'], value: 2 },
                            abilities: [
                                'Shrewd Diplomats: Use Int or Wis instead of Cha for Persuasion',
                                'Regeneration: Heal to full HP during long rest',
                                'No genetic memory (created with flaw)'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                },
                'Unas': {
                    subraces: {
                        'Standard Unas': {
                            hitPoints: 14,
                            abilityIncrease: { type: 'choice', options: ['strength', 'constitution'], value: 2 },
                            abilities: [
                                'Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)',
                                'Robust: +4 Str for lifting/carrying, advantage on related Str checks',
                                'Claws: Natural weapons deal 1d6 damage'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        },
                        'Unchained Unas': {
                            hitPoints: 14,
                            abilityIncrease: { type: 'choice', options: ['strength', 'constitution'], value: 2 },
                            abilities: [
                                'Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)',
                                'Underestimated: Advantage on checks to conceal truth from non-Unas',
                                'Claws: Natural weapons deal 1d6 damage'
                            ],
                            proficiencies: {
                                skills: { type: 'choice', count: 2, options: 'any' }
                            }
                        }
                    }
                }
            },

            classes: {
                'Diplomat': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms'],
                        tools: ['Research Kit'],
                        saves: ['Wisdom', 'Charisma'],
                        skills: ['Culture', 'Deception', 'Insight', 'Persuasion']
                    },
                    abilities: {
                        1: ['Inspire (1d6 temp HP to team during long rest)', 'Choose Inspiration feat'],
                        2: ['Pep Talk (restore 1d4 DP to team once per mission)', 'Word In An Ear (inspire single target)'],
                        3: ['Force of Will (use Inspire on short/long rest)', 'Choose 2nd Inspiration feat'],
                        4: ['Diplomatic Expertise (double proficiency)', 'Ability Score Improvement'],
                        5: ['Strong Personality (Inspire die to 1d8)', 'Choose 3rd Inspiration feat']
                    },
                    featChoices: {
                        1: { type: 'inspiration', count: 1 },
                        3: { type: 'inspiration', count: 1 },
                        5: { type: 'inspiration', count: 1 }
                    }
                },
                'Engineer': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms', 'Longarms'],
                        tools: ['Engineering Kit', 'Explosives', 'Fabrication Kit'],
                        saves: ['Dexterity', 'Intelligence'],
                        skills: ['Engineering', 'Pilot', 'Perception']
                    },
                    abilities: {
                        1: ['Jury Rig (2d8 repair, action repair)', 'Choose Modification feat'],
                        2: ['Hold Together (resistance with cover)', 'Whack-It (1d6 temp HP bonus action)'],
                        3: ['Tune-Up (+Int to repairs)', 'Choose 2nd Modification feat'],
                        4: ['Broad Spectrum Scanners (Int for Perception)', 'Ability Score Improvement'],
                        5: ['Xeno-Tech Specialist (reduce R&D time)', 'Choose 3rd Modification feat']
                    },
                    featChoices: {
                        1: { type: 'modification', count: 1 },
                        3: { type: 'modification', count: 1 },
                        5: { type: 'modification', count: 1 }
                    }
                },
                'Medic': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms', 'Shotguns'],
                        tools: ['Med Kit', 'Outbreak Kit'],
                        saves: ['Dexterity', 'Wisdom'],
                        skills: ['Athletics', 'Insight', 'Medicine', 'Science']
                    },
                    abilities: {
                        1: ['First Aid (add proficiency to healing, heal as action)', 'Choose Procedure feat'],
                        2: ['Triage (learn target HP with Medicine check)', 'Unnoticed Field Medic (disadvantage on attacks after healing)'],
                        3: ['Man Down (dying allies need fewer death saves)', 'Choose 2nd Procedure feat'],
                        4: ['Physician Heal Thyself (use med kit on self as bonus action)', 'Ability Score Improvement'],
                        5: ['First Response (add WIS modifier to healing)', 'Choose 3rd Procedure feat']
                    },
                    featChoices: {
                        1: { type: 'procedure', count: 1 },
                        3: { type: 'procedure', count: 1 },
                        5: { type: 'procedure', count: 1 }
                    }
                },
                'Scientist': {
                    hitDie: 8,
                    hpPerLevel: 5,
                    determinationBonus: 2,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Sidearms'],
                        tools: ['Explosives', 'Research Kit', 'Translator'],
                        saves: ['Intelligence', 'Wisdom'],
                        skills: ['Culture', 'Investigation', 'Nature', 'Science']
                    },
                    abilities: {
                        1: ['Eureka (gain points on Int/Wis failures)', 'Choose Discovery feat'],
                        2: ['Apt Analogy (+TD to ally checks)', 'Great Mind (immune to charm, advantage vs lies)'],
                        3: ['Cross-discipline Studies (half prof to non-proficient)', 'Choose 2nd Discovery feat'],
                        4: ['Resilient Mind (reduce mental damage)', 'Ability Score Improvement'],
                        5: ['Casual Genius (start with Eureka points)', 'For Science! (Eureka for Cha)', 'Choose 3rd Discovery feat']
                    },
                    featChoices: {
                        1: { type: 'discovery', count: 1 },
                        3: { type: 'discovery', count: 1 },
                        5: { type: 'discovery', count: 1 }
                    }
                },
                'Scout': {
                    hitDie: 10,
                    hpPerLevel: 6,
                    determinationBonus: 1,
                    proficiencies: {
                        armor: ['Light Armor'],
                        weapons: ['Common Weapons', 'Martial Arts', 'Bows', 'Sidearms', 'Longarms'],
                        tools: ['Camo Kit', 'Explosives'],
                        saves: ['Constitution', 'Dexterity'],
                        skills: ['Perception', 'Stealth', 'Survival']
                    },
                    abilities: {
                        1: ['Survivalist (resistance to environmental damage)', 'Choose Field Hack feat'],
                        2: ['Vanguard (+1d6 damage within 5m)', 'Trap Rigging (set traps as action)'],
                        3: ['Uncanny Dodge (reaction for resistance)', 'Scout\'s Cunning (bonus action dash/disengage/hide)'],
                        4: ['Ability Score Improvement', 'Choose 2nd Field Hack feat'],
                        5: ['Evasion (half damage on Dex saves)']
                    },
                    featChoices: {
                        1: { type: 'fieldHack', count: 1 },
                        4: { type: 'fieldHack', count: 1 }
                    }
                },
                'Soldier': {
                    hitDie: 10,
                    hpPerLevel: 6,
                    determinationBonus: 1,
                    proficiencies: {
                        armor: ['Light Armor', 'Heavy Armor'],
                        weapons: ['Common Weapons', 'Martial Arts', 'Sidearms', 'Longarms'],
                        tools: ['Camo Kit', 'Explosives'],
                        saves: ['Strength', 'Constitution'],
                        skills: ['Athletics', 'Intimidation', 'Pilot']
                    },
                    abilities: {
                        1: ['Tactical Flexibility (activate unknown tactic)', 'Choose Tactic feat'],
                        2: ['Surge (extra action, once per rest)', 'Rally (heal TD HP when wounded at combat start)'],
                        3: ['Martial Training (min d8 melee damage)', 'Improved Critical (19-20 with chosen weapon)'],
                        4: ['Ability Score Improvement', 'Choose 2nd Tactic feat'],
                        5: ['Tactical Superiority (two tactics active)']
                    },
                    featChoices: {
                        1: { type: 'tactic', count: 1 },
                        4: { type: 'tactic', count: 1 }
                    }
                }
            },

            origins: {
                biome: [
                    { name: 'Lunar', attribute: 'Dexterity +1', ability: 'Eager Astronomer: Advantage on Science checks pertaining to astronomy' },
                    { name: 'Arboreal', attribute: 'Strength +1', ability: 'Natural Climber: Climb speed of 6m' },
                    { name: 'Mountainous', attribute: 'Strength +1', ability: 'Vertical Drop: Half falling damage' },
                    { name: 'Artificial', attribute: 'Wisdom +1', ability: 'Life or Death Repairs: Advantage on engineering when failure would deal damage' },
                    { name: 'Oceanic', attribute: 'Wisdom +1', ability: 'Gifted Swimmer: Swim speed of 6m' },
                    { name: 'Desert', attribute: 'Charisma +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                    { name: 'Rainforest', attribute: 'Charisma +1', ability: 'Tropics Adept: No disadvantage from rain or fog' },
                    { name: 'Grasslands', attribute: 'Constitution +1', ability: 'Natural Sprinter: +1m movement speed' },
                    { name: 'Starship', attribute: 'Dexterity +1', ability: 'Void Adept: Use Wis for Science checks' },
                    { name: 'Terraformed', attribute: 'Intelligence +1', ability: 'Strange World: 1/day reaction for advantage on save' },
                    { name: 'Swamp', attribute: 'Wisdom +1', ability: 'Patient Hunter: Use Wis for Stealth checks' },
                    { name: 'Toxic', attribute: 'Constitution +1', ability: 'Toxic Resistance: Resist poison or necrotic (choose one)' },
                    { name: 'Urban', attribute: 'Intelligence +1', ability: 'Melting Pot: Use Cha for Culture checks' },
                    { name: 'Tundra', attribute: 'Constitution +1', ability: 'Cold Acclimated: Resistance to cold damage' },
                    { name: 'Volcanic', attribute: 'Strength +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                    { name: 'Subterranean', attribute: 'Dexterity +1', ability: 'Improved Vision: Dim light counts as bright' }
                ],
                background: [
                    { name: 'Enforcement', proficiency: 'Intimidation', ability: 'Air of Authority: Others have disadvantage to intimidate you' },
                    { name: 'Aviator', proficiency: 'Pilot', ability: 'Crash Landing: Resistance to damage when vehicle crashes' },
                    { name: 'Driver', proficiency: 'Animal Handling', ability: 'Speedster: Vehicles/animals you control gain +1 AC' },
                    { name: 'Enslaved', proficiency: { type: 'choice', options: ['Tool'] }, ability: 'Friend to Toil: Suffer 1 less exhaustion level (min 1)' },
                    { name: 'Former Host', proficiency: 'None', ability: 'Naquadah Blooded: Can use Goa\'uld tech, advantage vs symbiotes' },
                    { name: 'Entertainer', proficiency: 'Performance', ability: 'Zeitgeist: Use Cha for art/performance understanding' },
                    { name: 'Freedom Fighter', proficiency: 'Stealth', ability: 'Last Resorts: Disadvantage on Moxie, advantage on Initiative' },
                    { name: 'Healer', proficiency: 'Medicine', ability: 'Soothe: Team heals +Prof bonus on rest' },
                    { name: 'Military', proficiency: { type: 'choice', options: ['Weapon', 'Armor'] }, ability: 'Drills: +1 HP per level' },
                    { name: 'Herdsman', proficiency: 'Animal Handling', ability: 'Beastfriend: Use Cha instead of Wis for Animal Handling' },
                    { name: 'Preservationist', proficiency: 'Nature', ability: 'Eye for Nature: Advantage on checks to identify plants' },
                    { name: 'Hunter/Gatherer', proficiency: 'Survival', ability: 'Irongut: Advantage vs poison' },
                    { name: 'Politician', proficiency: 'Persuasion', ability: 'Two Faces: Use Int instead of Cha for Deception' },
                    { name: 'Liaison', proficiency: 'Culture', ability: 'Stranger to the Land: Advantage on Cha checks to hide foreign nature' },
                    { name: 'Refugee', proficiency: 'Athletics', ability: 'New Environments: Advantage on Athletics in unknown wilderness' },
                    { name: 'Merchant', proficiency: 'Insight', ability: 'Efficient Logistics: +1 bulk capacity' },
                    { name: 'Sailor', proficiency: 'Acrobatics', ability: 'Sea Legs: Advantage to maintain balance' },
                    { name: 'Swindler', proficiency: 'Deception', ability: 'Low Profile: Use Deception for Stealth in populated areas' },
                    { name: 'Scholar', proficiency: 'Science', ability: 'Preserve Knowledge: Advantage on Persuasion with scholars' },
                    { name: 'Teacher', proficiency: 'Insight', ability: 'Patient Approach: 1/mission use Wis save instead of another' },
                    { name: 'Sentry', proficiency: 'Perception', ability: 'Long Night: Ignore first night without rest' },
                    { name: 'Wright', proficiency: 'Engineering', ability: 'Measure Twice: Half prof bonus on non-proficient tools' },
                    { name: 'Sleuth', proficiency: 'Investigation', ability: 'The Reveal: Advantage on Persuasion to accuse wrongdoing' },
                    { name: 'Underworld', proficiency: 'Sleight of Hand', ability: 'Black Market: Advantage contacting underworld members' },
                    { name: 'Student', proficiency: 'Perception', ability: 'Quick Study: 1/mission use Int save instead of another' }
                ],
                racial: {
                    'Human': [
                        { name: 'Tau\'ri Military', attribute: 'None', proficiency: { type: 'choice', options: ['Martial Arts', 'Longarms', 'Heavy Armor'] }, ability: 'Basic Training: Chosen proficiency from military service' }
                    ],
                    'Jaffa': [
                        { name: 'Jaffa Renegade', attribute: 'Wisdom +1', ability: 'Rebel: Advantage on saves vs Goa\'uld and Jaffa' },
                        { name: 'Student of Bra\'tac', attribute: 'Dexterity +1', ability: 'Ma\'tok Mastery: Ma\'tok gains finesse property' }
                    ],
                    'Aturen': [
                        { name: 'Aturen Spiritualist', attribute: 'None', ability: 'Ritual of Life: DC 20 Culture check to resurrect' }
                    ],
                    'Tok\'ra': [
                        { name: 'Tok\'ra Spy', attribute: 'Charisma +1', ability: 'Passing: Advantage on Deception as Human/Goa\'uld/Jaffa' }
                    ],
                    'Unas': [
                        { name: 'Unas Alpha', attribute: 'Charisma +1', ability: 'Clan Leader: Other Unas gain advantage on saves/attacks' }
                    ]
                }
            },

            availableTools: [
                'Camo Kit', 'Explosives', 'Med Kit', 'Research Kit',
                'Surgical Kit', 'Translator', 'Thieves\' Tools',
                'Tok\'ra tunneling crystals', 'Engineering tools'
            ],

            availableSkills: [
                'Acrobatics', 'Athletics', 'Culture', 'Deception', 'Engineering',
                'Insight', 'Intimidation', 'Investigation', 'Medicine', 'Nature',
                'Perception', 'Performance', 'Persuasion', 'Pilot', 'Science',
                'Sleight of Hand', 'Stealth', 'Survival'
            ],

            availableWeapons: [
                'Common Weapons', 'Bows', 'Martial Arts', 'Sidearms',
                'Shotguns', 'Longarms', 'Grenades', 'Heavy Ordinance',
                'Jaffa Weapons'
            ],

            availableArmor: [
                'Light Armor', 'Medium Armor', 'Heavy Armor', 'Shields'
            ]
        };

        // State management
        let state = {
            character: {
                name: '',
                race: '',
                subrace: '',
                abilityChoice: '',
                origins: [],
                originChoices: {},
                raceChoices: {},
                class: '',
                level: 1,
                classFeats: [],
                abilityScoreImprovements: {},
                abilityScores: {
                    strength: 10,
                    dexterity: 10,
                    constitution: 10,
                    intelligence: 10,
                    wisdom: 10,
                    charisma: 10
                },
                hp: 0,
                maxHp: 0,
                determinationPoints: 0,
                armorClass: 10,
                speed: 6,
                initiative: 0,
                moxie: 0,
                proficiencies: {
                    armor: [],
                    weapons: [],
                    tools: [],
                    saves: [],
                    skills: []
                },
                bonusFeats: []
            },
            showClassFeats: true,
            showClassAbilities: true,
            attackSpecialistChoice: ''
        };

        // Utility functions
        function getModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function getProficiencyBonus(level) {
            if (level <= 4) return 2;
            if (level <= 8) return 3;
            if (level <= 12) return 4;
            if (level <= 16) return 5;
            return 6;
        }

        const pointBuyCost = {
            8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
        };

        function getPointsSpent() {
            return Object.values(state.character.abilityScores).reduce((sum, score) => {
                return sum + (pointBuyCost[score] || 0);
            }, 0);
        }

        function getProficiencyDescription(proficiencies) {
            const descriptions = [];
            
            if (proficiencies?.skills) {
                if (proficiencies.skills.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.skills.count} skill${proficiencies.skills.count > 1 ? 's' : ''}`);
                } else if (proficiencies.skills.type === 'mixed') {
                    const fixedSkills = proficiencies.skills.fixed.join(', ');
                    descriptions.push(`${fixedSkills} (fixed)`);
                    if (proficiencies.skills.additionalChoice) {
                        descriptions.push(`Choose ${proficiencies.skills.additionalChoice.count} additional skill${proficiencies.skills.additionalChoice.count > 1 ? 's' : ''}`);
                    }
                }
            }
            
            if (proficiencies?.weapons) {
                if (proficiencies.weapons.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.weapons.count} weapon proficiency`);
                } else if (proficiencies.weapons.type === 'fixed') {
                    descriptions.push(`${proficiencies.weapons.list.join(', ')} (fixed)`);
                }
            }
            
            if (proficiencies?.armor) {
                if (proficiencies.armor.type === 'fixed') {
                    descriptions.push(`${proficiencies.armor.list.join(', ')} (fixed)`);
                }
            }
            
            return descriptions;
        }

        function getAbilityBonuses(ability) {
            let racialBonus = 0;
            let originBonus = 0;
            let asiBonus = 0;
            
            const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
            if (raceData && raceData.abilityIncrease) {
                if (raceData.abilityIncrease.type === 'choice' && state.character.abilityChoice === ability) {
                    racialBonus = raceData.abilityIncrease.value;
                }
            }
            
            state.character.origins.forEach(originName => {
                const biomeOrigin = gameData.origins.biome.find(o => o.name === originName);
                const racialOrigin = Object.values(gameData.origins.racial).flat().find(o => o.name === originName);
                
                if (biomeOrigin && biomeOrigin.attribute !== 'None') {
                    const parts = biomeOrigin.attribute.split(' +');
                    if (parts[0].toLowerCase() === ability) {
                        originBonus += parseInt(parts[1]);
                    }
                }
                
                if (racialOrigin && racialOrigin.attribute !== 'None') {
                    const parts = racialOrigin.attribute.split(' +');
                    if (parts[0].toLowerCase() === ability) {
                        originBonus += parseInt(parts[1]);
                    }
                }
            });
            
            if (state.character.level >= 4 && state.character.abilityScoreImprovements) {
                Object.values(state.character.abilityScoreImprovements).forEach(improvement => {
                    if (improvement === ability) {
                        asiBonus += 1;
                    } else if (improvement === `${ability}_2`) {
                        asiBonus += 2;
                    }
                });
            }
            
            return { racialBonus, originBonus, asiBonus };
        }

        function getFinalAbilityScores() {
            const finalScores = { ...state.character.abilityScores };
            
            Object.keys(finalScores).forEach(ability => {
                const { racialBonus, originBonus, asiBonus } = getAbilityBonuses(ability);
                finalScores[ability] += racialBonus + originBonus + asiBonus;
            });
            
            return finalScores;
        }

        function getHPBreakdown() {
            const breakdown = {
                classBase: 0,
                conModifier: 0,
                raceBonus: 0,
                levelBonus: 0,
                militaryBonus: 0,
                total: 0
            };
            
            if (!state.character.race || !state.character.subrace || !state.character.class) return breakdown;
            
            const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
            const classData = gameData.classes[state.character.class];
            const finalScores = getFinalAbilityScores();
            const conMod = getModifier(finalScores.constitution);
            
            breakdown.classBase = classData.hitDie;
            breakdown.conModifier = conMod;
            breakdown.raceBonus = raceData.hitPoints;
            
            if (state.character.origins.includes('Military')) {
                breakdown.militaryBonus = state.character.level;
            }
            
            if (state.character.level > 1) {
                breakdown.levelBonus = (state.character.level - 1) * (classData.hpPerLevel + conMod);
            }
            
            breakdown.total = Math.max(1, 
                breakdown.classBase + 
                breakdown.conModifier + 
                breakdown.raceBonus + 
                breakdown.levelBonus +
                breakdown.militaryBonus
            );
            
            return breakdown;
        }

        function updateDerivedStats() {
            const hpBreakdown = getHPBreakdown();
            const finalScores = getFinalAbilityScores();
            const dexMod = getModifier(finalScores.dexterity);
            const wisMod = getModifier(finalScores.wisdom);
            const intMod = getModifier(finalScores.intelligence);
            const chaMod = getModifier(finalScores.charisma);
            
            let speed = 6;
            if (state.character.origins.includes('Grasslands')) {
                speed = 7;
            }
            
            state.character.hp = hpBreakdown.total;
            state.character.maxHp = hpBreakdown.total;
            state.character.initiative = Math.max(dexMod, wisMod);
            state.character.moxie = Math.max(intMod, chaMod);
            state.character.armorClass = 10 + dexMod;
            state.character.speed = speed;
            
            const detBase = Math.floor((state.character.level + 4) / 5) * 2;
            const detClassBonus = state.character.class ? gameData.classes[state.character.class].determinationBonus : 0;
            state.character.determinationPoints = detBase + detClassBonus;
        }

        function exportCharacterSheet() {
            const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
            const classData = gameData.classes[state.character.class];
            const finalScores = getFinalAbilityScores();
            
            let sheet = `STARGATE RPG CHARACTER SHEET
=============================
Name: ${state.character.name || 'Unnamed Character'}
Race: ${state.character.race} (${state.character.subrace})
Origins: ${state.character.origins.join(', ')}
Class: ${state.character.class}
Level: ${state.character.level}
Proficiency Bonus: +${getProficiencyBonus(state.character.level)}

ABILITY SCORES (with all modifiers)
Strength:     ${finalScores.strength} (${getModifier(finalScores.strength) >= 0 ? '+' : ''}${getModifier(finalScores.strength)})
Dexterity:    ${finalScores.dexterity} (${getModifier(finalScores.dexterity) >= 0 ? '+' : ''}${getModifier(finalScores.dexterity)})
Constitution: ${finalScores.constitution} (${getModifier(finalScores.constitution) >= 0 ? '+' : ''}${getModifier(finalScores.constitution)})
Intelligence: ${finalScores.intelligence} (${getModifier(finalScores.intelligence) >= 0 ? '+' : ''}${getModifier(finalScores.intelligence)})
Wisdom:       ${finalScores.wisdom} (${getModifier(finalScores.wisdom) >= 0 ? '+' : ''}${getModifier(finalScores.wisdom)})
Charisma:     ${finalScores.charisma} (${getModifier(finalScores.charisma) >= 0 ? '+' : ''}${getModifier(finalScores.charisma)})

COMBAT STATS
Hit Points: ${state.character.hp}/${state.character.maxHp}
Armor Class: ${state.character.armorClass}
Initiative: ${state.character.initiative >= 0 ? '+' : ''}${state.character.initiative}
Speed: ${state.character.speed}m
Determination Points: ${state.character.determinationPoints}
Moxie: ${state.character.moxie >= 0 ? '+' : ''}${state.character.moxie}

PROFICIENCIES
${classData ? 
`Armor: ${classData.proficiencies.armor.join(', ')}
Weapons: ${classData.proficiencies.weapons.join(', ')}
Tools: ${classData.proficiencies.tools.join(', ')}
Saves: ${classData.proficiencies.saves.join(', ')}
Skills: ${classData.proficiencies.skills.join(', ')}` : 'None selected'}

RACIAL ABILITIES
${raceData ? raceData.abilities.join('\n') : 'None'}

CLASS FEATS SELECTED
${state.character.classFeats.join('\n') || 'None selected'}
`;
            
            const element = document.createElement('a');
            const file = new Blob([sheet], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `${state.character.name || 'stargate_character'}_sheet.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Rendering functions
        function render() {
            updateDerivedStats();
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                        ${renderHeader()}
                        <div class="p-6 space-y-6">
                            ${renderCharacterName()}
                            ${renderRaceSelection()}
                            ${state.character.race ? renderSubraceSelection() : ''}
                            ${renderAbilityChoice()}
                            ${renderRaceProficiencyChoices()}
                            ${renderOrigins()}
                            ${renderOriginChoices()}
                            ${renderClassSelection()}
                            ${state.character.class ? renderClassInfo() : ''}
                            ${renderLevelSelection()}
                            ${state.character.class && state.character.level > 0 ? renderClassAbilities() : ''}
                            ${renderClassFeats()}
                            ${state.character.level === 5 ? renderAttackSpecialist() : ''}
                            ${state.character.level >= 4 ? renderASI() : ''}
                            ${renderAbilityScores()}
                            ${renderCombatStats()}
                            ${renderExportButton()}
                        </div>
                    </div>
                </div>
            `;
            attachEventListeners();
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                    <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                            ${icons.target}
                        </div>
                        Stargate RPG Character Builder
                    </h1>
                    <p class="text-blue-100 mt-2">Create your Phoenix Site operative (Levels 1-5)</p>
                </div>
            `;
        }

        function renderCharacterName() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Character Name
                    </label>
                    <input
                        type="text"
                        id="character-name"
                        value="${state.character.name}"
                        class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none"
                        placeholder="Enter character name..."
                    />
                </div>
            `;
        }

        function renderRaceSelection() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Select Race
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${Object.keys(gameData.races).map(race => `
                            <button
                                data-race="${race}"
                                class="race-btn p-3 rounded-lg border-2 transition-all ${
                                    state.character.race === race
                                        ? 'border-blue-500 bg-blue-500/20 text-white'
                                        : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                }"
                            >
                                <div class="font-semibold">${race}</div>
                                <div class="text-xs mt-1 opacity-75">
                                    ${Object.keys(gameData.races[race].subraces).length} variant(s)
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSubraceSelection() {
            if (!state.character.race) return '';
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Select ${state.character.race} Variant
                    </label>
                    <div class="space-y-3">
                        ${Object.entries(gameData.races[state.character.race].subraces).map(([subraceName, subraceData]) => {
                            const proficiencyDesc = getProficiencyDescription(subraceData.proficiencies);
                            
                            return `
                                <div
                                    data-subrace="${subraceName}"
                                    class="subrace-btn p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        state.character.subrace === subraceName
                                            ? 'border-green-500 bg-green-500/20'
                                            : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                    }"
                                >
                                    <div class="font-semibold text-white mb-2">${subraceName}</div>
                                    <div class="text-xs text-gray-400 space-y-1">
                                        <div>HP Bonus: +${subraceData.hitPoints}</div>
                                        <div class="flex items-start gap-1">
                                            <span>Ability Increase:</span>
                                            <span class="${subraceData.abilityIncrease.type === 'choice' ? 'text-yellow-300' : 'text-gray-400'}">
                                                ${subraceData.abilityIncrease.type === 'choice' ? 
                                                    `${icons.alertCircle} Choose ONE: +${subraceData.abilityIncrease.value} to ${subraceData.abilityIncrease.options.join(' OR ')}`
                                                    : 
                                                    Object.entries(subraceData.abilityIncrease)
                                                        .filter(([key]) => key !== 'type')
                                                        .map(([key, val]) => `${key}: +${val}`)
                                                        .join(', ')
                                                }
                                            </span>
                                        </div>
                                        
                                        ${proficiencyDesc.length > 0 ? `
                                            <div class="mt-2">
                                                <span class="font-semibold text-gray-300">Proficiencies:</span>
                                                <ul class="ml-2 mt-1">
                                                    ${proficiencyDesc.map(desc => `
                                                        <li class="text-xs text-blue-300">• ${desc}</li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="mt-2">
                                            <span class="font-semibold text-gray-300">Abilities:</span>
                                            <ul class="ml-2 mt-1">
                                                ${subraceData.abilities.map(ability => `
                                                    <li class="text-xs">• ${ability}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAbilityChoice() {
            if (!state.character.race || !state.character.subrace) return '';
            
            const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
            if (!raceData?.abilityIncrease?.type || raceData.abilityIncrease.type !== 'choice') return '';
            
            return `
                <div class="${!state.character.abilityChoice ? 'bg-yellow-500/20 border-2 border-yellow-500' : 'bg-gray-700/50'} rounded-lg p-4">
                    <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                        ${!state.character.abilityChoice ? icons.alertCircle : ''}
                        <span class="${!state.character.abilityChoice ? 'text-yellow-300' : 'text-gray-300'}">
                            Choose ONE Ability Score Increase (+${raceData.abilityIncrease.value})
                        </span>
                    </label>
                    ${!state.character.abilityChoice ? `
                        <p class="text-xs text-yellow-200 mb-3">
                            ⚠️ You must select which ability score receives the racial bonus. Only ONE ability can be chosen.
                        </p>
                    ` : ''}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        ${raceData.abilityIncrease.options.map(ability => `
                            <button
                                data-ability-choice="${ability}"
                                class="ability-choice-btn p-3 rounded capitalize transition-all font-semibold ${
                                    state.character.abilityChoice === ability
                                        ? 'bg-purple-500/20 border-2 border-purple-500 text-white'
                                        : 'bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-gray-500'
                                }"
                            >
                                ${ability}
                                ${state.character.abilityChoice === ability ? `
                                    <div class="text-xs mt-1 text-purple-300">✓ Selected</div>
                                ` : ''}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderRaceProficiencyChoices() {
            if (!state.character.race || !state.character.subrace) return '';
            
            const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
            let html = '';
            
            // Standard skills choice
            if (raceData?.proficiencies?.skills?.type === 'choice') {
                html += `
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Choose ${raceData.proficiencies.skills.count} Skill Proficienc${raceData.proficiencies.skills.count > 1 ? 'ies' : 'y'}
                        </label>
                        <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                            ${gameData.availableSkills.map(skill => {
                                const isSelected = state.character.raceChoices.skills?.includes(skill);
                                const maxReached = (state.character.raceChoices.skills?.length || 0) >= raceData.proficiencies.skills.count;
                                
                                return `
                                    <button
                                        data-race-skill="${skill}"
                                        class="race-skill-btn p-2 rounded text-xs transition-all ${
                                            isSelected
                                                ? 'bg-green-500/20 border border-green-500 text-white'
                                                : maxReached
                                                ? 'bg-gray-800 border border-gray-600 text-gray-300 opacity-50'
                                                : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                        }"
                                    >
                                        ${skill}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Mixed type (Tollan)
            if (raceData?.proficiencies?.skills?.type === 'mixed') {
                html += `
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Fixed Skill Proficiencies
                            </label>
                            <div class="flex gap-2">
                                ${raceData.proficiencies.skills.fixed.map(skill => `
                                    <span class="px-3 py-1 bg-blue-500/20 border border-blue-500 text-blue-300 rounded text-sm">
                                        ${skill} (Automatic)
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${raceData.proficiencies.skills.additionalChoice ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Choose ${raceData.proficiencies.skills.additionalChoice.count} Additional Skill Proficienc${raceData.proficiencies.skills.additionalChoice.count > 1 ? 'ies' : 'y'}
                                </label>
                                <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                                    ${gameData.availableSkills
                                        .filter(skill => !raceData.proficiencies.skills.fixed.includes(skill))
                                        .map(skill => {
                                            const isSelected = state.character.raceChoices.additionalSkills?.includes(skill);
                                            const maxReached = (state.character.raceChoices.additionalSkills?.length || 0) >= raceData.proficiencies.skills.additionalChoice.count;
                                            
                                            return `
                                                <button
                                                    data-additional-skill="${skill}"
                                                    class="additional-skill-btn p-2 rounded text-xs transition-all ${
                                                        isSelected
                                                            ? 'bg-green-500/20 border border-green-500 text-white'
                                                            : maxReached
                                                            ? 'bg-gray-800 border border-gray-600 text-gray-300 opacity-50'
                                                            : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                                    }"
                                                >
                                                    ${skill}
                                                </button>
                                            `;
                                        }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Weapon choice
            if (raceData?.proficiencies?.weapons?.type === 'choice') {
                html += `
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Choose ${raceData.proficiencies.weapons.count} Weapon Proficiency
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            ${gameData.availableWeapons.map(weapon => `
                                <button
                                    data-race-weapon="${weapon}"
                                    class="race-weapon-btn p-2 rounded text-sm transition-all ${
                                        state.character.raceChoices.weapons?.[0] === weapon
                                            ? 'bg-green-500/20 border border-green-500 text-white'
                                            : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                    }"
                                >
                                    ${weapon}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function renderOrigins() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Select Origins (Choose 2 from different categories)
                    </label>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-400 mb-2">Biome Origins</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto p-1">
                                ${gameData.origins.biome.map(origin => {
                                    const isSelected = state.character.origins.includes(origin.name);
                                    const hasBiome = state.character.origins.some(o => gameData.origins.biome.find(b => b.name === o));
                                    const disabled = !isSelected && (state.character.origins.length >= 2 || hasBiome);
                                    
                                    return `
                                        <button
                                            data-origin="${origin.name}"
                                            data-origin-type="biome"
                                            class="origin-btn p-3 text-left rounded border transition-all ${
                                                isSelected
                                                    ? 'border-blue-500 bg-blue-500/20'
                                                    : disabled
                                                    ? 'border-gray-600 bg-gray-800 opacity-50'
                                                    : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                            }"
                                        >
                                            <div class="font-semibold text-sm text-white">${origin.name}</div>
                                            <div class="text-xs text-green-400 mt-1">${origin.attribute}</div>
                                            <div class="text-xs text-gray-400">${origin.ability}</div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-semibold text-gray-400 mb-2">Background Origins</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto p-1">
                                ${gameData.origins.background.map(origin => {
                                    const isSelected = state.character.origins.includes(origin.name);
                                    const hasBackground = state.character.origins.some(o => gameData.origins.background.find(b => b.name === o));
                                    const isIncompatible = origin.name === 'Former Host' && state.character.race === 'Jaffa';
                                    const disabled = !isSelected && (state.character.origins.length >= 2 || hasBackground || isIncompatible);
                                    
                                    return `
                                        <button
                                            data-origin="${origin.name}"
                                            data-origin-type="background"
                                            class="origin-btn p-3 text-left rounded border transition-all ${
                                                isSelected
                                                    ? 'border-blue-500 bg-blue-500/20'
                                                    : isIncompatible
                                                    ? 'border-red-600 bg-red-900/20 opacity-50 cursor-not-allowed'
                                                    : disabled
                                                    ? 'border-gray-600 bg-gray-800 opacity-50'
                                                    : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                            }"
                                        >
                                            <div class="font-semibold text-sm text-white flex items-center gap-2">
                                                ${origin.name}
                                                ${isIncompatible ? `
                                                    <span class="text-xs text-red-400">(Incompatible with Jaffa)</span>
                                                ` : ''}
                                            </div>
                                            <div class="text-xs text-green-400 mt-1">
                                                Prof: ${typeof origin.proficiency === 'object' ? 
                                                    (origin.proficiency.options[0] === 'Weapon' ? 'Choose Weapon' :
                                                     origin.proficiency.options[0] === 'Armor' ? 'Choose Armor' :
                                                     origin.proficiency.options[0] === 'Tool' ? 'Choose Tool' :
                                                     'Choose') : 
                                                    origin.proficiency}
                                            </div>
                                            <div class="text-xs text-gray-400">${origin.ability}</div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        ${state.character.race && gameData.origins.racial[state.character.race] ? `
                            <div>
                                <h3 class="text-sm font-semibold text-gray-400 mb-2">Racial Origins (${state.character.race})</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${gameData.origins.racial[state.character.race].map(origin => {
                                        const isSelected = state.character.origins.includes(origin.name);
                                        const disabled = !isSelected && state.character.origins.length >= 2;
                                        
                                        return `
                                            <button
                                                data-origin="${origin.name}"
                                                data-origin-type="racial"
                                                class="origin-btn p-3 text-left rounded border transition-all ${
                                                    isSelected
                                                        ? 'border-blue-500 bg-blue-500/20'
                                                        : disabled
                                                        ? 'border-gray-600 bg-gray-800 opacity-50'
                                                        : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                                }"
                                            >
                                                <div class="font-semibold text-sm text-white">${origin.name}</div>
                                                <div class="text-xs text-green-400 mt-1">
                                                    ${origin.attribute}
                                                    ${origin.proficiency ? `
                                                        <span class="ml-2">
                                                            | Prof: ${origin.proficiency?.type === 'choice' ? origin.proficiency.options.join('/') : origin.proficiency}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div class="text-xs text-gray-400">${origin.ability}</div>
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    ${state.character.origins.length > 0 ? `
                        <div class="mt-3 flex gap-2 flex-wrap">
                            <span class="text-xs text-gray-400">Selected:</span>
                            ${state.character.origins.map(origin => `
                                <span
                                    data-remove-origin="${origin}"
                                    class="remove-origin text-xs px-2 py-1 bg-blue-500/20 text-blue-300 rounded cursor-pointer hover:bg-red-500/20 hover:text-red-300"
                                >
                                    ${origin} ×
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderOriginChoices() {
            let html = '';
            
            state.character.origins.forEach(originName => {
                const backgroundOrigin = gameData.origins.background.find(o => o.name === originName);
                const racialOrigin = gameData.origins.racial[state.character.race]?.find(o => o.name === originName);
                const origin = backgroundOrigin || racialOrigin;
                
                if (origin?.proficiency?.type === 'choice') {
                    const options = origin.proficiency.options;
                    let items = [];
                    
                    if (options.includes('Weapon')) {
                        items = gameData.availableWeapons;
                    } else if (options.includes('Armor')) {
                        items = gameData.availableArmor;
                    } else if (options.includes('Tool')) {
                        items = gameData.availableTools;
                    } else if (options.includes('Martial Arts') || options.includes('Longarms') || options.includes('Heavy Armor')) {
                        items = options;
                    }
                    
                    html += `
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Choose ${originName} Proficiency
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                ${items.map(item => `
                                    <button
                                        data-origin-choice="${originName}"
                                        data-choice-value="${item}"
                                        class="origin-choice-btn p-2 rounded text-sm transition-all ${
                                            state.character.originChoices[originName] === item
                                                ? 'bg-green-500/20 border border-green-500 text-white'
                                                : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                        }"
                                    >
                                        ${item}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        function renderClassSelection() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Select Class
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${Object.keys(gameData.classes).map(className => `
                            <button
                                data-class="${className}"
                                class="class-btn p-3 rounded-lg border-2 transition-all ${
                                    state.character.class === className
                                        ? 'border-purple-500 bg-purple-500/20 text-white'
                                        : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                }"
                            >
                                <div class="font-semibold">${className}</div>
                                <div class="text-xs mt-1 opacity-75">
                                    HD: d${gameData.classes[className].hitDie}, DP: +${gameData.classes[className].determinationBonus}
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderClassInfo() {
            const classData = gameData.classes[state.character.class];
            if (!classData) return '';
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">
                        <span class="icon icon-md">${icons.bookOpen}</span>
                        ${state.character.class} Class Proficiencies & Bonuses
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-purple-400 mb-2">Combat</div>
                            <div class="space-y-1 text-xs text-gray-300">
                                <div>Hit Die: d${classData.hitDie}</div>
                                <div>HP/Level: ${classData.hpPerLevel} + Con mod</div>
                                <div>Determination: +${classData.determinationBonus}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-blue-400 mb-2">Saving Throws</div>
                            <div class="text-xs text-gray-300">
                                ${classData.proficiencies.saves.join(', ')}
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-green-400 mb-2">Armor & Weapons</div>
                            <div class="space-y-1 text-xs text-gray-300">
                                <div><span class="text-gray-500">Armor:</span> ${classData.proficiencies.armor.join(', ')}</div>
                                <div><span class="text-gray-500">Weapons:</span> ${classData.proficiencies.weapons.join(', ')}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-yellow-400 mb-2">Tools</div>
                            <div class="text-xs text-gray-300">
                                ${classData.proficiencies.tools.join(', ') || 'None'}
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3 md:col-span-2">
                            <div class="text-xs font-semibold text-cyan-400 mb-2">Skills</div>
                            <div class="text-xs text-gray-300">
                                ${classData.proficiencies.skills.join(', ')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLevelSelection() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Character Level
                    </label>
                    <div class="grid grid-cols-5 gap-2">
                        ${Array.from({ length: 5 }, (_, i) => i + 1).map(level => `
                            <button
                                data-level="${level}"
                                class="level-btn px-3 py-2 rounded-lg border-2 transition-all text-sm ${
                                    state.character.level === level
                                        ? 'border-green-500 bg-green-500/20 text-white'
                                        : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                }"
                            >
                                ${level}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderClassAbilities() {
            const classData = gameData.classes[state.character.class];
            if (!classData) return '';
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <div 
                        id="toggle-abilities"
                        class="flex items-center justify-between cursor-pointer"
                    >
                        <h3 class="text-lg font-semibold text-gray-300 flex items-center gap-2">
                            <span class="icon icon-lg">${icons.bookOpen}</span>
                            ${state.character.class} Class Abilities (Levels 1-${state.character.level})
                        </h3>
                        <span class="${state.showClassAbilities ? 'rotate-180' : ''} transition-transform icon icon-lg">
                            ${icons.chevronDown}
                        </span>
                    </div>
                    
                    ${state.showClassAbilities ? `
                        <div class="mt-4 space-y-3">
                            ${Object.entries(classData.abilities)
                                .filter(([level]) => parseInt(level) <= state.character.level)
                                .map(([level, abilities]) => `
                                    <div class="bg-gray-800 rounded-lg p-3">
                                        <div class="text-sm font-semibold text-purple-400 mb-2">
                                            Level ${level}
                                        </div>
                                        <div class="space-y-2">
                                            ${abilities.filter(a => !a.includes('Choose') && !a.includes('Ability Score')).map(ability => {
                                                const colonIndex = ability.indexOf('(');
                                                const hasDescription = colonIndex !== -1;
                                                const abilityName = hasDescription ? ability.substring(0, colonIndex).trim() : ability;
                                                const abilityDesc = hasDescription ? ability.substring(colonIndex).trim() : '';
                                                
                                                return `
                                                    <div class="pl-2 border-l-2 border-gray-700">
                                                        <div class="text-sm font-medium text-white">
                                                            ${abilityName}
                                                        </div>
                                                        ${abilityDesc ? `
                                                            <div class="text-xs text-gray-400 mt-1">
                                                                ${abilityDesc}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderClassFeats() {
            if (!state.character.class) return '';
            
            const classData = gameData.classes[state.character.class];
            if (!classData.featChoices) return '';
            
            let requiredFeats = 0;
            let featType = null;
            
            Object.entries(classData.featChoices).forEach(([level, choice]) => {
                if (parseInt(level) <= state.character.level) {
                    requiredFeats += choice.count;
                    featType = choice.type;
                }
            });
            
            if (requiredFeats === 0) return '';
            
            const feats = featType === 'fieldHack' ? gameData.fieldHackFeats : gameData.classFeatsByType[featType];
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <div 
                        id="toggle-feats"
                        class="flex items-center justify-between cursor-pointer"
                    >
                        <h3 class="text-lg font-semibold text-gray-300 flex items-center gap-2">
                            <span class="icon icon-lg">${icons.sparkles}</span>
                            Class Feat Selection
                        </h3>
                        <span class="${state.showClassFeats ? 'rotate-180' : ''} transition-transform icon icon-lg">
                            ${icons.chevronDown}
                        </span>
                    </div>
                    
                    ${state.showClassFeats ? `
                        <p class="text-sm text-gray-400 mb-4 mt-3">
                            Select ${requiredFeats} ${state.character.class === 'Scout' ? 'Field Hack' : featType} feat${requiredFeats > 1 ? 's' : ''} for your ${state.character.class}
                        </p>
                        
                        <div class="space-y-2">
                            ${feats.map(feat => {
                                const isSelected = state.character.classFeats.includes(feat.name);
                                const canSelect = state.character.classFeats.length < requiredFeats && !isSelected;
                                
                                return `
                                    <button
                                        data-feat="${feat.name}"
                                        class="feat-btn w-full text-left p-3 rounded border transition-all ${
                                            isSelected
                                                ? 'border-purple-500 bg-purple-500/20'
                                                : canSelect
                                                ? 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                                : 'border-gray-700 bg-gray-900/50 opacity-50 cursor-not-allowed'
                                        }"
                                    >
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm text-white">${feat.name}</div>
                                                <div class="text-xs text-gray-400 mt-1">${feat.description}</div>
                                                ${feat.requirements && feat.requirements !== 'None' ? `
                                                    <div class="text-xs text-yellow-400 mt-1">Requirements: ${feat.requirements}</div>
                                                ` : ''}
                                            </div>
                                            ${isSelected ? `
                                                <div class="ml-2 text-purple-400">
                                                    ✓
                                                </div>
                                            ` : ''}
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-400">
                            Selected: ${state.character.classFeats.length}/${requiredFeats}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAttackSpecialist() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3 flex items-center gap-2">
                        <span class="icon icon-lg">${icons.award}</span>
                        Bonus Feat - Attack Specialist (Level 5)
                    </h3>
                    <p class="text-sm text-gray-400 mb-3">
                        Choose a weapon type to gain +1 to attack and damage rolls
                    </p>
                    <select
                        id="attack-specialist"
                        class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"
                    >
                        <option value="">Select weapon type...</option>
                        ${gameData.availableWeapons.map(weapon => `
                            <option value="${weapon}" ${state.attackSpecialistChoice === weapon ? 'selected' : ''}>${weapon}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        function renderASI() {
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-300 mb-4">
                        Level 4 - Ability Score Improvement
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">
                        Choose either: +2 to one ability score, OR +1 to two different ability scores
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Option 1: +2 to one ability
                            </label>
                            <select
                                id="asi-option1"
                                class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"
                            >
                                <option value="">Select ability...</option>
                                <option value="strength_2" ${state.character.abilityScoreImprovements?.option1 === 'strength_2' ? 'selected' : ''}>Strength +2</option>
                                <option value="dexterity_2" ${state.character.abilityScoreImprovements?.option1 === 'dexterity_2' ? 'selected' : ''}>Dexterity +2</option>
                                <option value="constitution_2" ${state.character.abilityScoreImprovements?.option1 === 'constitution_2' ? 'selected' : ''}>Constitution +2</option>
                                <option value="intelligence_2" ${state.character.abilityScoreImprovements?.option1 === 'intelligence_2' ? 'selected' : ''}>Intelligence +2</option>
                                <option value="wisdom_2" ${state.character.abilityScoreImprovements?.option1 === 'wisdom_2' ? 'selected' : ''}>Wisdom +2</option>
                                <option value="charisma_2" ${state.character.abilityScoreImprovements?.option1 === 'charisma_2' ? 'selected' : ''}>Charisma +2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Option 2: +1 to two abilities
                            </label>
                            <div class="space-y-2">
                                <select
                                    id="asi-option2a"
                                    class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"
                                >
                                    <option value="">First ability +1...</option>
                                    <option value="strength" ${state.character.abilityScoreImprovements?.option2a === 'strength' ? 'selected' : ''}>Strength +1</option>
                                    <option value="dexterity" ${state.character.abilityScoreImprovements?.option2a === 'dexterity' ? 'selected' : ''}>Dexterity +1</option>
                                    <option value="constitution" ${state.character.abilityScoreImprovements?.option2a === 'constitution' ? 'selected' : ''}>Constitution +1</option>
                                    <option value="intelligence" ${state.character.abilityScoreImprovements?.option2a === 'intelligence' ? 'selected' : ''}>Intelligence +1</option>
                                    <option value="wisdom" ${state.character.abilityScoreImprovements?.option2a === 'wisdom' ? 'selected' : ''}>Wisdom +1</option>
                                    <option value="charisma" ${state.character.abilityScoreImprovements?.option2a === 'charisma' ? 'selected' : ''}>Charisma +1</option>
                                </select>
                                <select
                                    id="asi-option2b"
                                    class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"
                                >
                                    <option value="">Second ability +1...</option>
                                    <option value="strength" ${state.character.abilityScoreImprovements?.option2b === 'strength' ? 'selected' : ''}>Strength +1</option>
                                    <option value="dexterity" ${state.character.abilityScoreImprovements?.option2b === 'dexterity' ? 'selected' : ''}>Dexterity +1</option>
                                    <option value="constitution" ${state.character.abilityScoreImprovements?.option2b === 'constitution' ? 'selected' : ''}>Constitution +1</option>
                                    <option value="intelligence" ${state.character.abilityScoreImprovements?.option2b === 'intelligence' ? 'selected' : ''}>Intelligence +1</option>
                                    <option value="wisdom" ${state.character.abilityScoreImprovements?.option2b === 'wisdom' ? 'selected' : ''}>Wisdom +1</option>
                                    <option value="charisma" ${state.character.abilityScoreImprovements?.option2b === 'charisma' ? 'selected' : ''}>Charisma +1</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAbilityScores() {
            const pointsSpent = getPointsSpent();
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-medium text-gray-300">
                            Ability Scores (Point Buy) - Base Values
                        </label>
                        <span class="${pointsSpent > 27 ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'} text-sm px-3 py-1 rounded-full">
                            Points: ${pointsSpent}/27
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${Object.entries(state.character.abilityScores).map(([ability, score]) => {
                            const { racialBonus, originBonus, asiBonus } = getAbilityBonuses(ability);
                            const totalBonus = racialBonus + originBonus + asiBonus;
                            const finalScore = score + totalBonus;
                            
                            return `
                                <div class="bg-gray-800 rounded-lg p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-gray-400 capitalize">${ability}</span>
                                        <span class="text-xs text-blue-300">
                                            Final: ${finalScore} (${getModifier(finalScore) >= 0 ? '+' : ''}${getModifier(finalScore)})
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button
                                            data-ability="${ability}"
                                            data-action="decrease"
                                            class="ability-btn w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white ${score <= 8 ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${score <= 8 ? 'disabled' : ''}
                                        >
                                            -
                                        </button>
                                        <div class="flex-1 text-center">
                                            <div class="text-lg font-bold text-white">${score}</div>
                                            ${totalBonus !== 0 ? `
                                                <div class="text-xs text-green-400">+${totalBonus}</div>
                                            ` : ''}
                                        </div>
                                        <button
                                            data-ability="${ability}"
                                            data-action="increase"
                                            class="ability-btn w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white ${score >= 15 || pointsSpent >= 27 ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${score >= 15 || pointsSpent >= 27 ? 'disabled' : ''}
                                        >
                                            +
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCombatStats() {
            const hpBreakdown = getHPBreakdown();
            const finalScores = getFinalAbilityScores();
            const dexMod = getModifier(finalScores.dexterity);
            const wisMod = getModifier(finalScores.wisdom);
            const intMod = getModifier(finalScores.intelligence);
            const chaMod = getModifier(finalScores.charisma);
            
            return `
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-300 mb-4">Combat Statistics</h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-red-400 mb-1">
                                <span class="icon icon-md">${icons.heart}</span>
                                <span class="text-xs">Hit Points</span>
                            </div>
                            <div class="text-2xl font-bold text-white">${state.character.hp || 0}</div>
                            <div class="text-xs text-gray-400 mt-1 space-y-0.5">
                                <div>Class HD: d${hpBreakdown.classBase}</div>
                                <div>Con Mod: ${hpBreakdown.conModifier >= 0 ? '+' : ''}${hpBreakdown.conModifier}</div>
                                <div>Race: +${hpBreakdown.raceBonus}</div>
                                ${hpBreakdown.levelBonus > 0 ? `<div>Level Bonus: +${hpBreakdown.levelBonus}</div>` : ''}
                                ${hpBreakdown.militaryBonus > 0 ? `<div>Military: +${hpBreakdown.militaryBonus}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-blue-400 mb-1">
                                <span class="icon icon-md">${icons.shield}</span>
                                <span class="text-xs">Armor Class</span>
                            </div>
                            <div class="text-2xl font-bold text-white">${state.character.armorClass}</div>
                            <div class="text-xs text-gray-400 mt-1 space-y-0.5">
                                <div>Base: 10</div>
                                <div>Dex Mod: ${dexMod >= 0 ? '+' : ''}${dexMod}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-yellow-400 mb-1">
                                <span class="icon icon-md">${icons.zap}</span>
                                <span class="text-xs">Initiative</span>
                            </div>
                            <div class="text-2xl font-bold text-white">
                                ${state.character.initiative >= 0 ? '+' : ''}${state.character.initiative}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 space-y-0.5">
                                <div>Dex: ${dexMod >= 0 ? '+' : ''}${dexMod}</div>
                                <div>Wis: ${wisMod >= 0 ? '+' : ''}${wisMod}</div>
                                <div class="text-blue-300">Use higher value</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-purple-400 mb-1">
                                <span class="icon icon-md">${icons.brain}</span>
                                <span class="text-xs">Determination</span>
                            </div>
                            <div class="text-2xl font-bold text-white">${state.character.determinationPoints}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                Base + Class Bonus
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-green-400 mb-1">
                                <span class="icon icon-md">${icons.activity}</span>
                                <span class="text-xs">Speed</span>
                            </div>
                            <div class="text-2xl font-bold text-white">${state.character.speed}m</div>
                            <div class="text-xs text-gray-400 mt-1">
                                Base: 6m
                                ${state.character.origins.includes('Grasslands') ? ' +1m (Grasslands)' : ''}
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-cyan-400 mb-1">
                                <span class="icon icon-md">${icons.user}</span>
                                <span class="text-xs">Moxie</span>
                            </div>
                            <div class="text-2xl font-bold text-white">
                                ${state.character.moxie >= 0 ? '+' : ''}${state.character.moxie}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 space-y-0.5">
                                <div>Int: ${intMod >= 0 ? '+' : ''}${intMod}</div>
                                <div>Cha: ${chaMod >= 0 ? '+' : ''}${chaMod}</div>
                                <div class="text-blue-300">Use higher value</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Proficiency Bonus</span>
                            <span class="text-lg font-bold text-white">+${getProficiencyBonus(state.character.level)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExportButton() {
            const isComplete = state.character.race && state.character.subrace && 
                             state.character.class && state.character.origins.length === 2;
            
            return `
                <div class="flex justify-end">
                    <button
                        id="export-btn"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all flex items-center gap-2 ${!isComplete ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${!isComplete ? 'disabled' : ''}
                    >
                        <span class="icon icon-lg">${icons.download}</span>
                        Export Character Sheet
                    </button>
                </div>
            `;
        }

        // Event handling
        function attachEventListeners() {
            // Character name
            const nameInput = document.getElementById('character-name');
            if (nameInput) {
                nameInput.addEventListener('input', (e) => {
                    state.character.name = e.target.value;
                });
            }

            // Race selection
            document.querySelectorAll('.race-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.character.race = btn.dataset.race;
                    state.character.subrace = '';
                    state.character.abilityChoice = '';
                    state.character.raceChoices = {};
                    render();
                });
            });

            // Subrace selection
            document.querySelectorAll('.subrace-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.character.subrace = btn.dataset.subrace;
                    state.character.abilityChoice = '';
                    state.character.raceChoices = {};
                    render();
                });
            });

            // Ability choice
            document.querySelectorAll('.ability-choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.character.abilityChoice = btn.dataset.abilityChoice;
                    render();
                });
            });

            // Race skills
            document.querySelectorAll('.race-skill-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const skill = btn.dataset.raceSkill;
                    if (!state.character.raceChoices.skills) {
                        state.character.raceChoices.skills = [];
                    }
                    
                    const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
                    const maxSkills = raceData?.proficiencies?.skills?.count || 1;
                    
                    if (state.character.raceChoices.skills.includes(skill)) {
                        state.character.raceChoices.skills = state.character.raceChoices.skills.filter(s => s !== skill);
                    } else if (state.character.raceChoices.skills.length < maxSkills) {
                        state.character.raceChoices.skills.push(skill);
                    }
                    
                    render();
                });
            });

            // Additional skills (for Tollan)
            document.querySelectorAll('.additional-skill-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const skill = btn.dataset.additionalSkill;
                    if (!state.character.raceChoices.additionalSkills) {
                        state.character.raceChoices.additionalSkills = [];
                    }
                    
                    const raceData = gameData.races[state.character.race]?.subraces[state.character.subrace];
                    const maxSkills = raceData?.proficiencies?.skills?.additionalChoice?.count || 1;
                    
                    if (state.character.raceChoices.additionalSkills.includes(skill)) {
                        state.character.raceChoices.additionalSkills = state.character.raceChoices.additionalSkills.filter(s => s !== skill);
                    } else if (state.character.raceChoices.additionalSkills.length < maxSkills) {
                        state.character.raceChoices.additionalSkills.push(skill);
                    }
                    
                    render();
                });
            });

            // Race weapons
            document.querySelectorAll('.race-weapon-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const weapon = btn.dataset.raceWeapon;
                    state.character.raceChoices.weapons = [weapon];
                    render();
                });
            });

            // Origins - updated to allow deselection
            document.querySelectorAll('.origin-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const originName = btn.dataset.origin;
                    const originType = btn.dataset.originType;
                    
                    if (state.character.origins.includes(originName)) {
                        // Deselect
                        state.character.origins = state.character.origins.filter(o => o !== originName);
                        delete state.character.originChoices[originName];
                    } else if (state.character.origins.length < 2) {
                        // Check if we already have an origin from this category
                        let hasFromCategory = false;
                        if (originType === 'biome') {
                            hasFromCategory = state.character.origins.some(o => 
                                gameData.origins.biome.find(b => b.name === o)
                            );
                        } else if (originType === 'background') {
                            hasFromCategory = state.character.origins.some(o => 
                                gameData.origins.background.find(b => b.name === o)
                            );
                        }
                        
                        if (!hasFromCategory) {
                            state.character.origins.push(originName);
                        }
                    }
                    render();
                });
            });

            // Remove origins
            document.querySelectorAll('.remove-origin').forEach(span => {
                span.addEventListener('click', () => {
                    const originToRemove = span.dataset.removeOrigin;
                    state.character.origins = state.character.origins.filter(o => o !== originToRemove);
                    delete state.character.originChoices[originToRemove];
                    render();
                });
            });

            // Origin choices
            document.querySelectorAll('.origin-choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const originName = btn.dataset.originChoice;
                    const choiceValue = btn.dataset.choiceValue;
                    state.character.originChoices[originName] = choiceValue;
                    render();
                });
            });

            // Class selection
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.character.class = btn.dataset.class;
                    state.character.classFeats = [];
                    state.character.abilityScoreImprovements = {};
                    render();
                });
            });

            // Level selection
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.character.level = parseInt(btn.dataset.level);
                    if (state.character.level === 5) {
                        state.character.bonusFeats = ['Attack Specialist'];
                    } else {
                        state.character.bonusFeats = [];
                    }
                    render();
                });
            });

            // Toggle abilities
            const toggleAbilities = document.getElementById('toggle-abilities');
            if (toggleAbilities) {
                toggleAbilities.addEventListener('click', () => {
                    state.showClassAbilities = !state.showClassAbilities;
                    render();
                });
            }

            // Toggle feats
            const toggleFeats = document.getElementById('toggle-feats');
            if (toggleFeats) {
                toggleFeats.addEventListener('click', () => {
                    state.showClassFeats = !state.showClassFeats;
                    render();
                });
            }

            // Class feats - allow deselection
            document.querySelectorAll('.feat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const featName = btn.dataset.feat;
                    if (state.character.classFeats.includes(featName)) {
                        state.character.classFeats = state.character.classFeats.filter(f => f !== featName);
                    } else {
                        const classData = gameData.classes[state.character.class];
                        let requiredFeats = 0;
                        Object.entries(classData.featChoices).forEach(([level, choice]) => {
                            if (parseInt(level) <= state.character.level) {
                                requiredFeats += choice.count;
                            }
                        });
                        
                        if (state.character.classFeats.length < requiredFeats) {
                            state.character.classFeats.push(featName);
                        }
                    }
                    render();
                });
            });

            // Attack specialist
            const attackSpecialist = document.getElementById('attack-specialist');
            if (attackSpecialist) {
                attackSpecialist.addEventListener('change', (e) => {
                    state.attackSpecialistChoice = e.target.value;
                    if (e.target.value) {
                        state.character.bonusFeats = [`Attack Specialist (${e.target.value})`];
                    }
                });
            }

            // ASI
            const asiOption1 = document.getElementById('asi-option1');
            if (asiOption1) {
                asiOption1.addEventListener('change', (e) => {
                    if (e.target.value) {
                        state.character.abilityScoreImprovements = {
                            option1: e.target.value
                        };
                        render();
                    }
                });
            }

            const asiOption2a = document.getElementById('asi-option2a');
            const asiOption2b = document.getElementById('asi-option2b');
            if (asiOption2a && asiOption2b) {
                asiOption2a.addEventListener('change', (e) => {
                    if (e.target.value) {
                        state.character.abilityScoreImprovements = {
                            option2a: e.target.value,
                            option2b: state.character.abilityScoreImprovements?.option2b || ''
                        };
                        render();
                    }
                });
                
                asiOption2b.addEventListener('change', (e) => {
                    if (e.target.value) {
                        state.character.abilityScoreImprovements = {
                            option2a: state.character.abilityScoreImprovements?.option2a || '',
                            option2b: e.target.value
                        };
                        render();
                    }
                });
            }

            // Ability scores
            document.querySelectorAll('.ability-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const ability = btn.dataset.ability;
                    const action = btn.dataset.action;
                    const currentValue = state.character.abilityScores[ability];
                    
                    if (action === 'increase' && currentValue < 15) {
                        const newTotal = getPointsSpent() + (pointBuyCost[currentValue + 1] - pointBuyCost[currentValue]);
                        if (newTotal <= 27) {
                            state.character.abilityScores[ability]++;
                            render();
                        }
                    } else if (action === 'decrease' && currentValue > 8) {
                        state.character.abilityScores[ability]--;
                        render();
                    }
                });
            });

            // Export button
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportCharacterSheet);
            }
        }

        // Initialize
        render();
    </script>
</body>
</html>
